<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت سیستم رهدیس</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        /* استایل تب‌سوییچ */
        .toggle-checkbox:checked { right: 0; border-color: #f59e0b; }
        .toggle-checkbox:checked + .toggle-label { background-color: #f59e0b; }
        
        /* مخفی کردن محتوا تا زمان بارگذاری کامل */
        body.loading > * { opacity: 0; }
        body.loading { pointer-events: none; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48ZyBmaWxsPSIjMWUyOTNiIiBmaWxsLW9wYWNpdHk9IjAuNCI+PHBhdGggZD0iTTM2IDM0di00aC0ydjRoLTR2MmgydjRoMnYtNGg0di0yaC00em0wLTMwVjBoLTJ2NGgtNHYyaDR2NGgyVjZoNFY0aC00ek02IDM0di00SDR2NEgwdjJoNHY0aDJ2LTRoNHYtMkg2ek02IDRWMEg0djRIMHYyaDR2NGgyVjZoNFY0SDZ6Ii8+PC9nPjwvZz48L3N2Zz4=')] loading">
    
    <div class="max-w-4xl mx-auto transition-opacity duration-500 ease-in-out">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-white">پنل مدیریت اطلاع‌رسانی</h1>
                <p class="text-slate-400 text-sm mt-1">مدیریت زمان‌بندی و محتوای ایمیل‌های سیستمی</p>
            </div>
            <a href="index.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition bg-slate-800 px-4 py-2 rounded-xl border border-slate-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span>بازگشت به داشبورد</span>
            </a>
        </header>

        <!-- لیست زمان‌بندی‌ها -->
        <div class="glass rounded-3xl overflow-hidden mb-8 shadow-2xl">
            <div class="bg-slate-800/80 p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-lg font-bold flex items-center gap-2 text-amber-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>زمان‌بندی‌های فعال</span>
                </h2>
                <button onclick="openAddModal()" class="bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold py-2.5 px-4 rounded-xl transition flex items-center gap-2 shadow-lg shadow-amber-500/20 active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    تعریف یادآوری جدید
                </button>
            </div>
            
            <div id="settings-list" class="p-6 space-y-4 min-h-[200px]">
                <div class="flex flex-col items-center justify-center h-full text-slate-500 gap-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-500"></div>
                    <span class="text-xs">در حال دریافت تنظیمات...</span>
                </div>
            </div>
        </div>

        <!-- راهنما -->
        <div class="bg-indigo-900/20 border border-indigo-500/20 rounded-2xl p-4 flex items-start gap-3">
            <svg class="w-6 h-6 text-indigo-400 mt-1 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <div class="text-sm text-indigo-200 leading-relaxed">
                <p class="font-bold mb-1">راهنمای هوشمند:</p>
                <ul class="list-disc list-inside space-y-1 text-xs opacity-80">
                    <li>متغیرهای زیر دقیقاً با نام ستون‌های دیتابیس هماهنگ شده‌اند:</li>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2 bg-slate-900/50 p-3 rounded border border-slate-700 font-mono text-[11px] text-amber-300 ltr">
                        <div class="text-right">{bank_name} : نام بانک</div>
                        <div class="text-right">{borrower_name} : نام وام‌گیرنده</div>
                        <div class="text-right">{loan_number} : شماره تسهیلات</div>
                        <div class="text-right">{loan_card_number} : شماره کارت</div>
                        <div class="text-right">{loan_shaba_number} : شماره شبا</div>
                        <div class="text-right">{amount} : مبلغ (محاسباتی)</div>
                        <div class="text-right">{due_date} : سررسید (محاسباتی)</div>
                    </div>
                    <li class="mt-2 text-amber-500">نکته: اگر هنوز فیلدی خالی است، بررسی کنید که در فرم «ثبت وام» آن را پر کرده باشید.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- مودال ویرایش/افزودن -->
    <div id="edit-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center p-4 z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-slate-900 w-full max-w-2xl rounded-3xl shadow-2xl border border-slate-700 flex flex-col max-h-[90vh]">
            
            <!-- هدر مودال -->
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <span id="modal-icon" class="bg-amber-500/10 text-amber-500 p-2 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></span>
                    <span id="modal-title">ویرایش تنظیمات</span>
                </h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-white transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <!-- بدنه مودال (اسکرول) -->
            <div class="p-6 overflow-y-auto space-y-8 custom-scrollbar">
                
                <!-- بخش ۱: اطلاعات پایه -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1.5">شناسه سیستمی (غیرقابل تغییر)</label>
                        <input id="edit-job-name" type="text" placeholder="مثال: loan_reminder_1" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm ltr placeholder-slate-700 focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition" required>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1.5">نام نمایشی (برای مدیریت)</label>
                        <input id="edit-display-name" type="text" placeholder="مثال: یادآوری هفتگی شنبه‌ها" class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition" required>
                    </div>
                </div>

                <!-- بخش ۲: زمان‌بندی هوشمند -->
                <div class="bg-slate-800/30 p-5 rounded-2xl border border-slate-700/50">
                    <div class="flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-sm font-bold text-white">تنظیم زمان ارسال (به وقت تهران)</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- انتخاب نوع تکرار -->
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1.5">تکرار</label>
                            <select id="schedule-type" onchange="toggleScheduleInputs()" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-amber-500">
                                <option value="daily">هر روز</option>
                                <option value="weekly">هفتگی</option>
                            </select>
                        </div>

                        <!-- انتخاب روز هفته (فقط در حالت هفتگی) -->
                        <div id="weekday-container" class="hidden">
                            <label class="block text-[10px] text-slate-400 mb-1.5">روز هفته</label>
                            <select id="schedule-weekday" onchange="generateCron()" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-3 py-2.5 text-sm outline-none focus:border-amber-500">
                                <option value="6">شنبه</option>
                                <option value="0">یک‌شنبه</option>
                                <option value="1">دوشنبه</option>
                                <option value="2">سه‌شنبه</option>
                                <option value="3">چهارشنبه</option>
                                <option value="4">پنج‌شنبه</option>
                                <option value="5">جمعه</option>
                            </select>
                        </div>

                        <!-- انتخاب ساعت -->
                        <div class="md:col-span-1">
                            <label class="block text-[10px] text-slate-400 mb-1.5">ساعت اجرا</label>
                            <input id="edit-time-tehran" type="time" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-3 py-2.5 text-lg text-center ltr text-white focus:border-amber-500 outline-none" onchange="generateCron()">
                        </div>
                    </div>
                    
                    <!-- نمایش کد کرون تولید شده -->
                    <div class="mt-4 flex justify-between items-center border-t border-slate-700/50 pt-3">
                        <span class="text-[10px] text-slate-500">کد استاندارد تولید شده (UTC):</span>
                        <code id="cron-preview" class="text-xs font-mono text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded">-- -- * * *</code>
                        <input id="edit-cron" type="hidden">
                    </div>
                </div>

                <!-- بخش ۳: محتوای ایمیل -->
                <div class="space-y-4">
                    <div class="flex justify-between items-end">
                        <label class="block text-xs text-slate-400">محتوای ایمیل</label>
                        
                        <!-- سوییچ حالت ساده/پیشرفته -->
                        <div class="flex items-center bg-slate-950 rounded-lg p-1 border border-slate-800">
                            <button onclick="setEditorMode('simple')" id="btn-mode-simple" class="px-3 py-1 text-[10px] rounded-md transition bg-slate-700 text-white">متن ساده</button>
                            <button onclick="setEditorMode('advanced')" id="btn-mode-advanced" class="px-3 py-1 text-[10px] rounded-md transition text-slate-400 hover:text-white">HTML پیشرفته</button>
                        </div>
                    </div>

                    <div>
                        <input id="edit-subject" type="text" placeholder="عنوان ایمیل (مثلا: یادآوری سررسید)" class="w-full bg-slate-950 border border-slate-800 rounded-t-xl px-4 py-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none border-b-0">
                        
                        <!-- ویرایشگر ساده -->
                        <textarea id="edit-body-simple" rows="5" placeholder="متن پیام خود را اینجا بنویسید..." class="w-full bg-slate-950 border border-slate-800 rounded-b-xl px-4 py-3 text-sm leading-relaxed focus:border-indigo-500 outline-none resize-none"></textarea>
                        
                        <!-- ویرایشگر پیشرفته (مخفی) -->
                        <textarea id="edit-body-html" rows="5" class="hidden w-full bg-slate-900 border border-slate-800 rounded-b-xl px-4 py-3 text-xs ltr font-mono text-indigo-300 focus:border-indigo-500 outline-none resize-none"></textarea>
                    </div>
                </div>

                <!-- وضعیت فعال -->
                <label class="flex items-center gap-3 cursor-pointer group w-max">
                    <div class="relative">
                        <input id="edit-active" type="checkbox" class="sr-only peer">
                        <div class="w-10 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </div>
                    <span class="text-sm text-slate-300 group-hover:text-white transition">وضعیت این یادآوری فعال باشد</span>
                </label>

            </div>

            <!-- فوتر مودال -->
            <div class="p-6 border-t border-slate-800 flex gap-3 bg-slate-900/50 rounded-b-3xl">
                <button onclick="saveSettings()" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-amber-500/20 active:scale-95 flex justify-center items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    ذخیره تغییرات
                </button>
                <button onclick="closeModal()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 rounded-xl transition active:scale-95">
                    انصراف
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // تنظیمات اتصال به Supabase 
        // ==========================================
        
        // مقادیر زیر را حتماً با اطلاعات واقعی پروژه خود جایگزین کنید
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

        let sb;

        try {
            if (typeof supabase !== 'undefined') {
                sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.error('کتابخانه Supabase بارگذاری نشده است.');
            }
        } catch (e) {
            console.error('خطا در راه‌اندازی Supabase:', e);
        }

        // بررسی لاگین و دسترسی ادمین
        async function checkAdminAuth() {
            if (!sb) {
                alert('اتصال به دیتابیس برقرار نیست.');
                return null;
            }
            
            const { data: { session }, error } = await sb.auth.getSession();
            
            if (error || !session) {
                // اگر کاربر لاگین نباشد، هدایت به صفحه لاگین
                window.location.href = 'index.html'; 
                return null;
            }

            // در اینجا می‌توانید چک کنید که آیا کاربر ادمین است یا خیر
            // مثال: چک کردن جدول profiles
            /*
            const { data: profile } = await sb.from('profiles').select('role').eq('id', session.user.id).single();
            if (profile?.role !== 'admin') {
                alert('شما اجازه دسترسی به این صفحه را ندارید.');
                window.location.href = 'index.html';
                return null;
            }
            */
            
            return session.user;
        }

        let currentEditingId = null;
        let editorMode = 'simple'; // simple | advanced

        // ==========================================
        // بخش منطق تبدیل زمان (NLP Logic)
        // ==========================================

        function generateCron() {
            const timeStr = document.getElementById('edit-time-tehran').value;
            if (!timeStr) return;

            const type = document.getElementById('schedule-type').value;
            const [h, m] = timeStr.split(':').map(Number);
            
            // تبدیل ساعت تهران به UTC
            // تهران: UTC+3:30 (یعنی ۲۱۰ دقیقه جلوتر)
            // فرمول: UTC = Tehran - 210 min
            let totalMinutesTehran = h * 60 + m;
            let totalMinutesUTC = totalMinutesTehran - 210;
            
            let dayShift = 0; // آیا روز عوض می‌شود؟ (مثلا ۲ شب تهران، میشه ۱۰:۳۰ شب قبل UTC)

            if (totalMinutesUTC < 0) {
                totalMinutesUTC += 1440; // +24 hours
                dayShift = -1; // یک روز برو عقب
            } else if (totalMinutesUTC >= 1440) {
                totalMinutesUTC -= 1440;
                dayShift = 1;
            }

            const cronH = Math.floor(totalMinutesUTC / 60);
            const cronM = totalMinutesUTC % 60;

            let cronString = "";

            if (type === 'daily') {
                // فرمت روزانه: m h * * *
                cronString = `${cronM} ${cronH} * * *`;
            } else {
                // فرمت هفتگی: m h * * dow
                let tehranDay = parseInt(document.getElementById('schedule-weekday').value); // 0-6 (Sat-Fri in UI logic, actually depends on cron std)
                
                // نگاشت UI (شنبه=6...جمعه=5) به استاندارد Cron (یکشنبه=0...شنبه=6)
                // فرض ما: UI Value: 6=Sat, 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri
                // استاندارد Cron: 0=Sun, 1=Mon... 6=Sat
                
                let cronDay = tehranDay; // خوشبختانه مپینگ ما یکی است (شنبه در کرون ۶ است، یکشنبه ۰)
                
                // اعمال شیفت روز
                cronDay += dayShift;
                if (cronDay < 0) cronDay = 6; // شنبه
                if (cronDay > 6) cronDay = 0; // یکشنبه

                cronString = `${cronM} ${cronH} * * ${cronDay}`;
            }

            document.getElementById('edit-cron').value = cronString;
            document.getElementById('cron-preview').innerText = cronString;
        }

        function parseCronToUI(cronStr) {
            // معکوس کردن منطق بالا برای نمایش در UI هنگام ویرایش
            try {
                const parts = cronStr.split(' ');
                const m = parseInt(parts[0]);
                const h = parseInt(parts[1]);
                const dow = parts[4];

                // تبدیل UTC به تهران
                let totalMinutesUTC = h * 60 + m;
                let totalMinutesTehran = totalMinutesUTC + 210;
                
                let dayShift = 0;
                if (totalMinutesTehran >= 1440) {
                    totalMinutesTehran -= 1440;
                    dayShift = 1; // تهران رفت روز بعد
                }

                const tehranH = Math.floor(totalMinutesTehran / 60);
                const tehranM = totalMinutesTehran % 60;
                const timeStr = `${String(tehranH).padStart(2,'0')}:${String(tehranM).padStart(2,'0')}`;

                // تشخیص نوع
                if (dow === '*') {
                    return { type: 'daily', time: timeStr, day: null };
                } else {
                    let cronDay = parseInt(dow);
                    // معکوس شیفت روز
                    // TehranDay = CronDay + (DayShift معکوس؟ نه، اختلاف روز)
                    // اگر در تبدیل رفت به تهران، روز رفت جلو، پس روز تهران یکی جلوتر از کرون است
                    let tehranDay = cronDay + dayShift; 
                    if (tehranDay > 6) tehranDay = 0;
                    
                    return { type: 'weekly', time: timeStr, day: tehranDay };
                }
            } catch (e) {
                return { type: 'daily', time: '12:00', day: null };
            }
        }

        function toggleScheduleInputs() {
            const type = document.getElementById('schedule-type').value;
            const weekContainer = document.getElementById('weekday-container');
            if (type === 'weekly') {
                weekContainer.classList.remove('hidden');
                // کلاس گرید والد را اصلاح کنیم
                weekContainer.parentElement.classList.remove('md:grid-cols-3');
                weekContainer.parentElement.classList.add('md:grid-cols-3'); 
            } else {
                weekContainer.classList.add('hidden');
            }
            generateCron();
        }

        // ==========================================
        // بخش ویرایشگر متن (HTML Logic)
        // ==========================================

        function setEditorMode(mode) {
            editorMode = mode;
            const simple = document.getElementById('edit-body-simple');
            const html = document.getElementById('edit-body-html');
            const btnSimple = document.getElementById('btn-mode-simple');
            const btnAdv = document.getElementById('btn-mode-advanced');

            if (mode === 'simple') {
                simple.classList.remove('hidden');
                html.classList.add('hidden');
                btnSimple.classList.replace('text-slate-400', 'text-white');
                btnSimple.classList.replace('bg-transparent', 'bg-slate-700'); // استایل دکمه فعال
                btnSimple.classList.add('bg-slate-700');
                
                btnAdv.classList.remove('bg-slate-700', 'text-white');
                btnAdv.classList.add('text-slate-400');
                
                // اگر قبلا کدی بود، سعی کنیم متنش رو در بیاریم (ساده سازی)
                // برای الان فرض می‌کنیم سینک یه طرفه است یا مدیر میدونه چیکار میکنه
            } else {
                simple.classList.add('hidden');
                html.classList.remove('hidden');
                
                btnAdv.classList.add('bg-slate-700', 'text-white');
                btnAdv.classList.remove('text-slate-400');
                
                btnSimple.classList.remove('bg-slate-700', 'text-white');
                btnSimple.classList.add('text-slate-400');

                // انتقال متن ساده به اچ تی ام ال اگر خالی بود
                if (!html.value && simple.value) {
                    html.value = `<div style="direction:rtl; font-family: Tahoma, sans-serif; line-height:1.6;">\n  <p>${simple.value.replace(/\n/g, '<br>')}</p>\n</div>`;
                }
            }
        }

        // ==========================================
        // عملیات CRUD
        // ==========================================

        async function loadSettings() {
            const container = document.getElementById('settings-list');
            
            if (!sb) {
                container.innerHTML = `<p class="text-red-400 text-center">خطا: اتصال به دیتابیس برقرار نیست. لطفا کلیدهای API را در کد وارد کنید.</p>`;
                return;
            }

            const { data, error } = await sb.from('notification_settings').select('*').order('id');
            
            if (error) {
                container.innerHTML = `<p class="text-red-400 text-center">خطا: ${error.message}</p>`;
                return;
            }

            container.innerHTML = data.map(s => {
                const info = parseCronToUI(s.cron_schedule);
                const dayNames = ['یک‌شنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه']; 
                // نگاشت آرایه UI: 0=Sun ...
                // UI Value ما: 6=Sat, 0=Sun...
                // بیایید نام روز را درست پیدا کنیم.
                let dayLabel = '';
                if(info.type === 'weekly') {
                      // تبدیل کد عددی روز به متن فارسی
                      // نگاشت ما: 6=شنبه, 0=یک, 1=دو...
                      const map = {6:'شنبه', 0:'یک‌شنبه', 1:'دوشنبه', 2:'سه‌شنبه', 3:'چهارشنبه', 4:'پنج‌شنبه', 5:'جمعه'};
                      dayLabel = map[info.day] + '‌ها، ';
                }

                return `
                <div class="bg-slate-800/50 border border-slate-700 hover:border-amber-500/50 rounded-2xl p-5 flex flex-col md:flex-row justify-between items-center gap-4 transition group">
                    <div class="flex-1 w-full">
                        <div class="flex items-center justify-between md:justify-start gap-3 mb-2">
                            <span class="font-bold text-white text-lg">${s.display_name}</span>
                            <span class="text-[10px] px-2 py-0.5 rounded-full border ${s.is_active ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-slate-700 text-slate-400'}">
                                ${s.is_active ? 'فعال' : 'غیرفعال'}
                            </span>
                        </div>
                        <div class="flex flex-wrap items-center gap-3 text-xs text-slate-400">
                            <div class="flex items-center gap-1.5 bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700/50">
                                <svg class="w-3.5 h-3.5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span class="text-slate-200">${dayLabel}ساعت ${info.time}</span>
                            </div>
                            <div class="flex items-center gap-1.5 truncate max-w-[250px]">
                                <span class="text-slate-500">موضوع:</span>
                                <span class="text-slate-300">${s.email_subject}</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="openEditModal(${JSON.stringify(s).replace(/"/g, '&quot;')})" class="w-full md:w-auto bg-slate-700 group-hover:bg-amber-500 group-hover:text-white text-slate-300 text-xs font-bold px-5 py-2.5 rounded-xl transition flex justify-center items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        ویرایش تنظیمات
                    </button>
                </div>
            `}).join('');
        }

        function openAddModal() {
            currentEditingId = null;
            document.getElementById('modal-title').innerText = "افزودن یادآوری جدید";
            
            document.getElementById('edit-job-name').value = '';
            document.getElementById('edit-job-name').disabled = false; 
            document.getElementById('edit-display-name').value = '';
            
            // پیش‌فرض‌ها
            document.getElementById('schedule-type').value = 'daily';
            toggleScheduleInputs();
            document.getElementById('edit-time-tehran').value = '12:00';
            generateCron();
            
            document.getElementById('edit-subject').value = 'یادآوری پرداخت قسط - {bank_name}';
            
            // متن پیش‌فرض با متغیرهای صحیح
            const defaultTemplate = `سلام {borrower_name} عزیز،

یادآوری سررسید پرداخت قسط تسهیلات شما فرا رسیده است.

اطلاعات تسهیلات:
• بانک: {bank_name}
• مبلغ قسط: {amount} تومان
• تاریخ سررسید: {due_date}

اطلاعات حساب جهت واریز:
• شماره تسهیلات: {loan_number}
• شماره کارت: {loan_card_number}
• شماره شبا: {loan_shaba_number}

لطفاً در اسرع وقت نسبت به پرداخت اقدام نمایید.
با تشکر، سیستم مدیریت رهدیس`;

            document.getElementById('edit-body-simple').value = defaultTemplate;
            document.getElementById('edit-body-html').value = '';
            setEditorMode('simple');
            
            document.getElementById('edit-active').checked = true;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function openEditModal(data) {
            currentEditingId = data.id;
            document.getElementById('modal-title').innerText = "ویرایش یادآوری";
            
            document.getElementById('edit-job-name').value = data.job_name;
            document.getElementById('edit-job-name').disabled = true;
            document.getElementById('edit-display-name').value = data.display_name;
            
            // بازیابی زمان
            const info = parseCronToUI(data.cron_schedule);
            document.getElementById('schedule-type').value = info.type;
            toggleScheduleInputs();
            if (info.type === 'weekly') {
                document.getElementById('schedule-weekday').value = info.day;
            }
            document.getElementById('edit-time-tehran').value = info.time;
            generateCron(); // Refresh preview

            // بازیابی محتوا
            document.getElementById('edit-subject').value = data.email_subject;
            document.getElementById('edit-body-html').value = data.email_template;
            
            // تلاش برای استخراج متن ساده از HTML (خیلی ساده)
            let simpleText = data.email_template.replace(/<[^>]*>/g, '').trim(); 
            // پاکسازی فاصله‌های اضافی
            simpleText = simpleText.replace(/\s+/g, ' ');
            document.getElementById('edit-body-simple').value = simpleText;
            
            setEditorMode('simple'); // پیش فرض روی ساده باز شود برای راحتی
            
            document.getElementById('edit-active').checked = data.is_active;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        async function saveSettings() {
            try {
                // Check DB Connection
                if (!sb) {
                    alert('خطا: ارتباط با سرور برقرار نیست. لطفا کلیدهای API را در کد وارد کنید.');
                    return;
                }

                // Basic Validation
                const jobName = document.getElementById('edit-job-name').value.trim();
                const displayName = document.getElementById('edit-display-name').value.trim();
                const cron = document.getElementById('edit-cron').value;

                if (!jobName || !displayName || !cron) {
                    alert('لطفاً تمام فیلدهای ضروری (شناسه سیستمی، نام نمایشی و زمان‌بندی) را پر کنید.');
                    return;
                }

                // ساخت بدنه نهایی
                let finalBody = '';
                if (editorMode === 'simple') {
                    const txt = document.getElementById('edit-body-simple').value;
                    // تبدیل متن ساده به استاندارد HTML حرفه‌ای و ریسپانسیو
                    finalBody = `
<div style="direction: rtl; font-family: 'Vazirmatn', Tahoma, sans-serif; background-color: #f3f4f6; margin: 0; padding: 40px 0;">
    <table align="center" border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden;">
        <!-- Header -->
        <tr>
            <td style="background-color: #1e293b; padding: 24px; text-align: center; border-bottom: 4px solid #f59e0b;">
                <h1 style="color: #ffffff; margin: 0; font-size: 20px; font-weight: bold; font-family: 'Vazirmatn', sans-serif;">سیستم هوشمند رهدیس</h1>
            </td>
        </tr>
        <!-- Content -->
        <tr>
            <td style="padding: 32px 24px; color: #334155; font-size: 16px; line-height: 1.8;">
                ${txt.split('\n').filter(l => l.trim()).map(line => `<p style="margin: 0 0 16px;">${line}</p>`).join('')}
            </td>
        </tr>
        <!-- Footer -->
        <tr>
            <td style="background-color: #f8fafc; padding: 16px; text-align: center; border-top: 1px solid #e2e8f0;">
                <p style="margin: 0; font-size: 12px; color: #94a3b8;">این ایمیل به صورت خودکار ارسال شده است.<br>لطفاً به این پیام پاسخ ندهید.</p>
            </td>
        </tr>
    </table>
</div>`;
                } else {
                    finalBody = document.getElementById('edit-body-html').value;
                }

                const updates = {
                    job_name: jobName,
                    display_name: displayName,
                    cron_schedule: cron,
                    email_subject: document.getElementById('edit-subject').value,
                    email_template: finalBody,
                    is_active: document.getElementById('edit-active').checked,
                    updated_at: new Date()
                };

                let error;
                if (currentEditingId) {
                    const res = await sb.from('notification_settings').update(updates).eq('id', currentEditingId);
                    error = res.error;
                } else {
                    // For new records, let DB handle created_at, or if needed:
                    // updates.created_at = new Date(); 
                    const res = await sb.from('notification_settings').insert([updates]);
                    error = res.error;
                }

                if (error) {
                    console.error('Supabase Error:', error);
                    alert('خطا در ذخیره‌سازی: ' + error.message + '\n(See console for details)');
                } else {
                    closeModal();
                    loadSettings();
                }
            } catch (err) {
                console.error('Application Error:', err);
                alert('خطای سیستمی رخ داد: ' + err.message);
            }
        }

        // بررسی ورود کاربر هنگام لود صفحه
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAdminAuth();
            if (user) {
                document.body.classList.remove('loading'); // نمایش صفحه بعد از تایید هویت
                loadSettings();
            }
        });
    </script>
</body>
</html>