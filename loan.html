<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت هوشمند وام و نقطه سر به سر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Jalaali Date Library -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script>
        // Protect this page
        document.addEventListener('DOMContentLoaded', () => {
            if (window.checkAuthGuard) checkAuthGuard();
        });
    </script>

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f1f5f9; }
        .input-group label { font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 0.25rem; display: block; }
        .input-group input, .input-group select { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; outline: none; transition: all 0.2s; }
        .input-group input:focus { border-color: #3b82f6; ring: 2px solid #93c5fd; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .status-bar-bg { background-color: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; position: relative; }
        .status-bar-fill { height: 100%; transition: width 0.5s ease-in-out, background-color 0.3s; }
        
        /* Validation Icons CSS */
        .validation-icon {
            display: none;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #10b981; /* Emerald 500 */
            pointer-events: none;
            transition: all 0.2s ease-in-out;
        }
        .input-wrapper.valid .validation-icon { 
            display: block; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .input-wrapper.valid input { 
            border-color: #10b981; 
            background-color: #f0fdf4; 
            padding-right: 2.5rem; /* Make space for icon */
        }
        @keyframes popIn {
            0% { transform: translateY(-50%) scale(0); opacity: 0; }
            100% { transform: translateY(-50%) scale(1); opacity: 1; }
        }

        /* Calendar Specific Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { 
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border-radius: 8px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; position: relative;
            background-color: #f8fafc; border: 1px solid transparent;
        }
        .calendar-day:hover { background-color: #e2e8f0; border-color: #cbd5e1; }
        .calendar-day.selected { background-color: #3b82f6; color: white; border-color: #2563eb; }
        .calendar-day.today { border: 2px solid #f59e0b; font-weight: bold; }
        .calendar-day.empty { background-color: transparent; cursor: default; }
        
        .event-badge {
            position: absolute; bottom: 2px; right: 2px; background-color: #ef4444; color: white;
            font-size: 0.6rem; width: 14px; height: 14px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: white; border-radius: 1rem; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 1.5rem; position: relative; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="p-3 md:p-8 min-h-screen pb-20">

    <!-- Top Bar: Global Settings -->
    <div class="max-w-7xl mx-auto mb-6 bg-slate-900 text-white p-4 rounded-2xl card-shadow flex flex-col md:flex-row justify-between items-center gap-4 sticky top-2 z-50">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="bg-amber-500 p-2 rounded-lg text-white shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
            </div>
            <div>
                <h1 class="text-base md:text-lg font-bold">داشبورد مدیریت وام</h1>
                <p class="text-xs text-slate-400">کنترل تعهدات مالی و نقطه سر به سر</p>
            </div>
        </div>

        <div class="flex flex-wrap md:flex-nowrap items-center gap-3 w-full md:w-auto bg-slate-800 p-2 rounded-xl border border-slate-700">
            <label class="text-xs md:text-sm text-amber-400 whitespace-nowrap font-bold pl-2 w-full md:w-auto">قیمت طلا (۱۸ عیار):</label>
            <div class="relative w-full md:w-48">
                <!-- IMPORTANT: Calls window.updateAllLoans() defined in script -->
                <input type="text" id="globalGoldPrice" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white font-mono text-left ltr focus:border-amber-500 outline-none text-sm" placeholder="در حال دریافت..." oninput="formatInput(this); window.updateAllLoans && window.updateAllLoans()">
                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-[10px] text-slate-500">Toman</span>
            </div>
            
            <!-- Auth Buttons & Home -->
            <div class="flex gap-2 w-full md:w-auto justify-end mt-2 md:mt-0">
                <button onclick="document.getElementById('formCard').scrollIntoView({behavior: 'smooth'})" class="text-xs bg-emerald-600 hover:bg-emerald-500 px-3 py-2 rounded text-white transition flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    <span class="hidden md:inline">ثبت وام</span>
                    <span class="md:hidden">جدید</span>
                </button>
                <a href="index.html" class="text-xs bg-slate-600 hover:bg-slate-500 px-3 py-2 rounded text-white transition flex items-center gap-1" title="بازگشت به خانه">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    <span class="hidden md:inline">خانه</span>
                </a>
                <button onclick="if(window.signOut) window.signOut()" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-white transition">خروج</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Column: Calendar & Add Form -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Calendar Widget -->
            <div class="bg-white p-4 md:p-5 rounded-2xl card-shadow">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        تقویم اقساط
                    </h2>
                    <div class="flex items-center gap-2 bg-slate-100 rounded-lg p-1">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-white rounded shadow-sm text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                        <span id="calendarMonthTitle" class="text-xs font-bold text-slate-700 w-20 md:w-24 text-center">...</span>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-white rounded shadow-sm text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                    </div>
                </div>

                <div class="calendar-grid mb-2 text-center text-[10px] text-slate-400 font-bold">
                    <div>ش</div><div>ی</div><div>د</div><div>س</div><div>چ</div><div>پ</div><div>ج</div>
                </div>
                
                <div id="calendarGrid" class="calendar-grid mb-4"></div>

                <div id="selectedDatePanel" class="border-top-2 border-slate-100 pt-3 mt-3 hidden">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <span class="text-[10px] text-slate-400 block">اقساط:</span>
                            <span id="selectedDateTitle" class="text-sm font-bold text-slate-800">...</span>
                        </div>
                        <div class="text-right">
                             <span class="text-[10px] text-slate-400 block">جمع پرداختی:</span>
                             <span id="selectedDateTotal" class="text-sm font-bold text-indigo-600 font-mono">0</span>
                        </div>
                    </div>
                    <div id="selectedDateList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="bg-slate-800 text-white p-5 md:p-6 rounded-2xl card-shadow">
                <h3 class="text-sm font-bold text-slate-400 mb-4">خلاصه وضعیت کل بدهی‌ها</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-2 flex-wrap gap-2">
                        <span class="text-xs md:text-sm">پرداختی‌های <span id="summaryMonthName" class="text-amber-400 font-bold">...</span>:</span>
                        <span id="sumMonthlyDue" class="text-lg md:text-xl font-bold text-white font-mono">0</span>
                    </div>
                    <div class="flex justify-between items-center border-b border-slate-700 pb-2 flex-wrap gap-2">
                        <span class="text-xs md:text-sm">کل مانده بدهی:</span>
                        <span id="sumRemainingDebt" class="text-lg md:text-xl font-bold text-red-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between items-center flex-wrap gap-2">
                        <span class="text-xs md:text-sm">ارزش روز کل طلاها:</span>
                        <span id="sumAssetValue" class="text-lg md:text-xl font-bold text-emerald-400 font-mono">0</span>
                    </div>
                </div>
            </div>

            <!-- Add/Edit Loan Form -->
            <div id="formCard" class="bg-white p-4 md:p-6 rounded-2xl card-shadow border-2 border-transparent transition-all">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 id="formTitle" class="text-base md:text-lg font-bold text-slate-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        ثبت تسهیلات جدید
                    </h2>
                    <button id="btnCancelEdit" onclick="cancelEditMode()" class="hidden text-xs text-red-500 bg-red-50 px-2 py-1 rounded hover:bg-red-100">انصراف</button>
                </div>
                
                <form id="loanForm" class="space-y-4">
                    <!-- Responsive Grid: 1 col on mobile, 2 cols on small screens and up -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="input-group">
                            <label>بانک / موسسه</label>
                            <input type="text" id="bankName" placeholder="مثلاً رسالت" required>
                        </div>
                        <div class="input-group">
                            <label>نام وام‌گیرنده</label>
                            <input type="text" id="borrower" placeholder="نام شخص" required>
                        </div>
                    </div>
                    
                    <!-- NEW FIELDS WITH FORMATTING -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <div class="input-group">
                            <label>شماره تسهیلات</label>
                            <input type="text" id="loanNumber" placeholder="شماره قرارداد" class="ltr text-left font-mono text-sm" inputmode="numeric">
                        </div>
                        <div class="input-group">
                            <label>شماره کارت تسهیلات</label>
                            <div class="relative input-wrapper" id="cardWrapper">
                                <input type="text" id="loanCardNumber" maxlength="19" placeholder="____-____-____-____" class="ltr text-left font-mono text-sm" oninput="formatCardNumber(this)" inputmode="numeric">
                                <svg xmlns="http://www.w3.org/2000/svg" class="validation-icon h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="input-group sm:col-span-2">
                            <label>شماره شبای تسهیلات (بدون IR)</label>
                            <div class="relative input-wrapper" id="shabaWrapper">
                                <input type="text" id="loanShabaNumber" maxlength="30" placeholder="__-____-____-____-____-____-__" class="ltr text-left font-mono text-sm pl-8" oninput="formatShabaNumber(this)" inputmode="numeric">
                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-slate-400 font-bold">IR</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="validation-icon h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <!-- END NEW FIELDS -->

                    <div class="input-group">
                        <label>مبلغ اصل وام (تومان)</label>
                        <!-- ADDED: onblur trigger for automatic calculation -->
                        <input type="text" id="principalAmount" inputmode="numeric" placeholder="0" class="ltr text-left" oninput="formatInput(this)" onblur="calculateAutomaticGoldWeight()" required>
                    </div>

                    <div class="input-group">
                        <label>مبلغ کل بازپرداخت (اصل + سود)</label>
                        <input type="text" id="totalRepayment" inputmode="numeric" placeholder="مبلغ نهایی بدهی" class="ltr text-left" oninput="formatInput(this)" required>
                    </div>

                    <div class="bg-amber-50 p-3 rounded-xl border border-amber-100">
                        <div class="input-group">
                            <label class="text-amber-800 flex justify-between items-center">
                                <span>وزن طلای خریداری شده</span>
                                <button type="button" onclick="calculateAutomaticGoldWeight()" class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded hover:bg-amber-200 transition">محاسبه مجدد</button>
                            </label>
                            <div class="relative">
                                <input type="number" step="0.001" id="goldWeight" placeholder="0.000" class="ltr text-left border-amber-200 focus:border-amber-500 bg-white">
                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-amber-600 font-bold">گرم</span>
                            </div>
                            <p id="goldCalcMessage" class="text-[10px] text-amber-600 mt-1 h-4"></p>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>نوع بازپرداخت</label>
                        <select id="repaymentType" class="bg-slate-50" onchange="toggleRepaymentFields(); syncDates('type')">
                            <option value="monthly">اقساط ماهانه (عادی)</option>
                            <option value="interval">اقساط دوره‌ای (مثلاً هر ۳ ماه)</option>
                            <option value="mudaraba">سررسید یکجا (مضاربه)</option>
                        </select>
                    </div>

                    <!-- Responsive Grid: Box Design -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 p-3 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="input-group" id="installmentsCountGroup">
                            <label>تعداد اقساط</label>
                            <input type="number" id="installmentsTotal" placeholder="12" required>
                        </div>
                        
                        <div class="input-group hidden" id="intervalGroup">
                            <label id="intervalLabel">فاصله اقساط (ماه)</label>
                            <input type="number" id="repaymentInterval" placeholder="3" onchange="syncDates('interval')">
                        </div>
                    </div>

                    <!-- Date Logic Section - Box Design -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 bg-indigo-50 p-3 rounded-xl border border-indigo-100">
                        <div class="input-group sm:col-span-2">
                            <label>تاریخ دریافت وام (شروع محاسبه)</label>
                            <div class="relative">
                                <!-- ADDED: calculateAutomaticGoldWeight() on change -->
                                <input type="text" id="startDate" placeholder="1403/10/01" class="ltr text-center font-mono w-full pl-10" onchange="syncDates('start'); calculateAutomaticGoldWeight();">
                                <button type="button" onclick="openDatePicker('startDate')" class="absolute left-1 top-1/2 -translate-y-1/2 text-indigo-500 hover:bg-indigo-100 p-1.5 rounded transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>دوره تنفس (ماه)</label>
                            <input type="number" id="gracePeriod" placeholder="0" class="border-indigo-200 focus:border-indigo-500 bg-white" onchange="syncDates('grace')">
                        </div>
                        
                        <div class="input-group">
                            <label>تاریخ اولین قسط</label>
                            <div class="relative">
                                <input type="text" id="firstInstallmentDate" placeholder="1403/11/01" class="ltr text-center font-mono border-indigo-200 focus:border-indigo-500 bg-white w-full pl-10" onchange="syncDates('first')">
                                <button type="button" onclick="openDatePicker('firstInstallmentDate')" class="absolute left-1 top-1/2 -translate-y-1/2 text-indigo-500 hover:bg-indigo-100 p-1.5 rounded transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Only needed for periodic adjustments -->
                    <div class="input-group hidden"> 
                        <label>روز پرداخت قسط</label>
                        <input type="number" id="dueDay" placeholder="مثلاً 5" min="1" max="31">
                    </div>

                    <button type="submit" id="btnSubmit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg mt-2">
                        ثبت وام در سیستم
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column -->
        <div class="lg:col-span-8">
            
            <!-- Overdue Alert Section (Accordion) -->
            <div id="overdueSection" class="hidden mb-6 bg-white border border-red-100 rounded-2xl shadow-sm overflow-hidden transition-all duration-300">
                <!-- Header / Summary -->
                <div onclick="toggleOverdue()" class="bg-red-50 p-4 md:p-5 flex justify-between items-center cursor-pointer hover:bg-red-100 transition relative">
                    <div class="absolute top-0 right-0 w-1 h-full bg-red-500"></div>
                    <div class="flex items-center gap-3">
                        <div class="bg-red-100 text-red-600 p-2 rounded-full shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <div>
                            <h2 class="text-red-800 font-bold text-sm md:text-base">اقساط سررسید گذشته (نیاز به اقدام)</h2>
                            <p id="overdueSummaryText" class="text-xs text-red-600 mt-1">در حال محاسبه...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <span id="overdueTotalBadge" class="bg-red-200 text-red-800 text-xs px-2 py-1 rounded-full font-bold">0</span>
                         <svg id="overdueChevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                         </svg>
                    </div>
                </div>

                <!-- Body / Details -->
                <div id="overdueBody" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out bg-white">
                    <div id="overdueList" class="p-4 space-y-2 border-t border-red-100"></div>
                </div>
            </div>

            <!-- Loan List -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base md:text-lg font-bold text-slate-800">لیست وام‌ها و وضعیت سر به سر</h2>
                <div class="flex gap-2">
                     <button onclick="fetchLoansDB()" class="text-xs text-blue-500 hover:text-blue-700 bg-blue-50 px-3 py-1 rounded-lg">بروزرسانی</button>
                </div>
            </div>
            
            <div id="loansList" class="space-y-4"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-slate-800">وضعیت اقساط و تاریخچه پرداخت</h3>
                <button onclick="closeModal('historyModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div id="historyModalContent" class="space-y-2"></div>
        </div>
    </div>

    <div id="paymentDateModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-800">ثبت پرداخت قسط</h3>
                <button onclick="closeModal('paymentDateModal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <p class="text-sm text-slate-600 mb-4">لطفاً تاریخ واقعی پرداخت را تایید یا اصلاح کنید:</p>
            <div class="input-group mb-4">
                <label>تاریخ پرداخت (شمسی)</label>
                <div class="relative">
                    <input type="text" id="confirmPaymentDate" class="ltr text-center font-mono text-lg border-blue-300 focus:ring-blue-200 w-full pl-10">
                    <button type="button" onclick="openDatePicker('confirmPaymentDate')" class="absolute left-1 top-1/2 -translate-y-1/2 text-blue-500 hover:bg-blue-100 p-2 rounded transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </button>
                </div>
            </div>
            <input type="hidden" id="pendingPaymentLoanId">
            <input type="hidden" id="pendingPaymentInstallmentNum">
            <button onclick="confirmPayment()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow">تایید و ثبت پرداخت</button>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div id="datePickerModal" class="modal-overlay" style="z-index: 200;">
        <div class="modal-content" style="max-width: 320px;">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div class="flex items-center gap-2">
                    <button onclick="changePickerMonth(-1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                    <span id="pickerTitle" class="text-sm font-bold text-slate-700 w-24 text-center">...</span>
                    <button onclick="changePickerMonth(1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                </div>
                <button onclick="closeModal('datePickerModal')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="calendar-grid mb-2 text-center text-[10px] text-slate-400 font-bold">
                <div>ش</div><div>ی</div><div>د</div><div>س</div><div>چ</div><div>پ</div><div>ج</div>
            </div>
            <div id="pickerGrid" class="calendar-grid"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 transition-all duration-300 translate-y-24 opacity-0 z-[100] border border-slate-700 pointer-events-none">
        <div id="toastIcon" class="bg-emerald-500 rounded-full p-1 shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        </div>
        <span id="toastMessage" class="font-bold text-sm">عملیات موفقیت‌آمیز بود</span>
    </div>

<script>
    // --- State Management ---
    let loans = [];
    let editingLoanId = null;
    let calYear, calMonth;
    
    // --- Utils ---
    const formatNumber = (num) => num ? parseInt(num).toLocaleString('en-US') : '0';
    const getRawValue = (val) => val ? parseInt(val.replace(/,/g, '').replace(/\D/g, '')) || 0 : 0;

    function formatInput(el) {
        let val = el.value.replace(/,/g, '').replace(/\D/g, '');
        if (val) el.value = parseInt(val).toLocaleString('en-US');
        else el.value = '';
    }

    // --- Toast Logic ---
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const msg = document.getElementById('toastMessage');
        const icon = document.getElementById('toastIcon');
        
        msg.innerText = message;
        
        if(type === 'success') {
            icon.className = 'bg-emerald-500 rounded-full p-1 shrink-0';
            icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
        } else {
             icon.className = 'bg-red-500 rounded-full p-1 shrink-0';
             icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
        }

        // Show
        toast.classList.remove('translate-y-24', 'opacity-0');
        
        // Hide after 3s
        setTimeout(() => {
            toast.classList.add('translate-y-24', 'opacity-0');
        }, 3000);
    }

    // --- Accordion Logic ---
    function toggleOverdue() {
        const body = document.getElementById('overdueBody');
        const chevron = document.getElementById('overdueChevron');
        
        if (body.style.maxHeight) {
            body.style.maxHeight = null;
            chevron.style.transform = 'rotate(0deg)';
        } else {
            body.style.maxHeight = body.scrollHeight + "px";
            chevron.style.transform = 'rotate(180deg)';
        }
    }

    // --- Formatting & Validation Functions ---
    function formatCardNumber(input) {
        let val = input.value.replace(/\D/g, ''); // remove non-digits
        if (val.length > 16) val = val.substring(0, 16);
        
        // Format for display: 1234-1234...
        let formatted = val.match(/.{1,4}/g)?.join('-') || val;
        input.value = formatted;
        
        // Validation visual
        const wrapper = input.parentElement;
        if (val.length === 16) wrapper.classList.add('valid');
        else wrapper.classList.remove('valid');
    }

    function validateShebaChecksum(shebaWithoutIR) {
        if (shebaWithoutIR.length !== 24) return false;
        
        // Standard IBAN Validation for Iran:
        // 1. Move "IR" + CheckDigits to the end.
        // IR in numeric: I=18, R=27.
        // Input: [CheckDigits][BBAN]
        // Rearranged: [BBAN] + "1827" + [CheckDigits]
        
        const checkDigits = shebaWithoutIR.substring(0, 2);
        const bban = shebaWithoutIR.substring(2);
        
        const numericStr = bban + "1827" + checkDigits;
        
        // Mod 97 Algorithm using BigInt (supported in modern browsers)
        if (typeof BigInt !== 'undefined') {
            return BigInt(numericStr) % 97n === 1n;
        }
        return false;
    }

    function formatShabaNumber(input) {
        let val = input.value.replace(/\D/g, ''); // remove non-digits
        if (val.length > 24) val = val.substring(0, 24);
        
        // Format: xx-xxxx-xxxx-xxxx-xxxx-xxxx-xx
        // Indices to split: 2, 6, 10, 14, 18, 22
        
        let formatted = '';
        for (let i = 0; i < val.length; i++) {
            if (i === 2 || i === 6 || i === 10 || i === 14 || i === 18 || i === 22) {
                formatted += '-';
            }
            formatted += val[i];
        }
        input.value = formatted;
        
        const wrapper = input.parentElement;
        
        // Validate checksum
        if (validateShebaChecksum(val)) {
            wrapper.classList.add('valid'); 
        } else {
            wrapper.classList.remove('valid');
        }
    }

    // --- Date Helpers ---
    function getTodayJalali() {
        if (typeof jalaali === 'undefined') return { jy: 1403, jm: 1, jd: 1 };
        return jalaali.toJalaali(new Date());
    }

    function parseJalaliString(str) {
        if (!str || str.length < 8) return getTodayJalali();
        const parts = str.split('/');
        return { jy: parseInt(parts[0]), jm: parseInt(parts[1]), jd: parseInt(parts[2]) };
    }

    function formatJalaliDate(jObj) {
        return `${jObj.jy}/${String(jObj.jm).padStart(2, '0')}/${String(jObj.jd).padStart(2, '0')}`;
    }

    function compareJalaliDates(d1Str, d2Str) {
        if (d1Str === d2Str) return 0;
        return d1Str > d2Str ? 1 : -1;
    }

    function addMonthsToJalali(dateObj, monthsToAdd) {
        let year = dateObj.jy;
        let month = dateObj.jm + monthsToAdd;
        let day = dateObj.jd;
        while (month > 12) { month -= 12; year += 1; }
        while (month < 1) { month += 12; year -= 1; }
        if (month > 6 && day === 31) day = 30;
        if (month === 12 && day > 29) {
            if (typeof jalaali !== 'undefined' && !jalaali.isValidJalaaliDate(year, 12, 30)) day = 29;
        }
        return { jy: year, jm: month, jd: day };
    }

    function calculateInstallmentDateV2(firstPaymentDateStr, installmentNum, interval = 1) {
        // Fallback if date is missing (db schema issue)
        if (!firstPaymentDateStr) {
            const today = getTodayJalali();
            firstPaymentDateStr = formatJalaliDate(today);
        }
        
        const start = parseJalaliString(firstPaymentDateStr);
        const monthsToAdd = (installmentNum - 1) * parseInt(interval);
        return addMonthsToJalali(start, monthsToAdd);
    }

    function diffInDays(targetJ, sourceJ) {
        if (typeof jalaali === 'undefined') return 0;
        const gTarget = jalaali.toGregorian(targetJ.jy, targetJ.jm, targetJ.jd);
        const gSource = jalaali.toGregorian(sourceJ.jy, sourceJ.jm, sourceJ.jd);
        const dTarget = new Date(gTarget.gy, gTarget.gm - 1, gTarget.gd);
        const dSource = new Date(gSource.gy, gSource.gm - 1, gSource.gd);
        return Math.ceil((dTarget - dSource) / (1000 * 60 * 60 * 24)); 
    }

    function diffInMonths(date1Str, date2Str) {
        const d1 = parseJalaliString(date1Str);
        const d2 = parseJalaliString(date2Str);
        return ((d2.jy - d1.jy) * 12) + (d2.jm - d1.jm);
    }

    // --- Live Price Fetching ---
    async function fetchLiveGoldPrice() {
        if (!sb) return; 
        try {
            const { data, error } = await sb
                .from('Iran_Data')
                .select('Gram_18K_Price')
                .order('id', { ascending: false })
                .limit(1)
                .single();
            if (data && data.Gram_18K_Price) {
                const price = data.Gram_18K_Price / 10;
                const inputEl = document.getElementById('globalGoldPrice');
                if (inputEl) {
                    inputEl.value = parseInt(price).toLocaleString('en-US');
                    if (window.updateAllLoans) window.updateAllLoans();
                }
            }
        } catch (err) { console.error('Fetch error:', err); }
    }

    // --- Historical Gold Weight Calculation ---
    async function calculateAutomaticGoldWeight() {
        const dateStr = document.getElementById('startDate').value;
        const principalStr = document.getElementById('principalAmount').value;
        const weightInput = document.getElementById('goldWeight');
        const msgEl = document.getElementById('goldCalcMessage');
        
        // Reset message
        if(msgEl) msgEl.innerText = "";

        if (!dateStr || !principalStr) return;

        const principal = getRawValue(principalStr);
        if (principal <= 0) return;

        // Visual feedback
        const originalPlaceholder = weightInput.placeholder;
        weightInput.placeholder = "در حال محاسبه...";
        if(msgEl) msgEl.innerText = "در حال جستجوی قیمت...";
        
        try {
            // Convert to Gregorian for reliable date searching
            const parts = parseJalaliString(dateStr);
            const gObj = jalaali.toGregorian(parts.jy, parts.jm, parts.jd);
            const gDateStr = `${gObj.gy}-${String(gObj.gm).padStart(2,'0')}-${String(gObj.gd).padStart(2,'0')}`;

            // Search for date <= selected date to handle holidays/Fridays
            const { data, error } = await sb
                .from('ArchiveTgju_gram18_Mordad_92')
                .select('high_price, date_jalali')
                .lte('date_gregorian', gDateStr)
                .order('date_gregorian', { ascending: false })
                .limit(1)
                .maybeSingle();

            if (error) {
                console.error("Error fetching historical price:", error);
                if(msgEl) msgEl.innerText = "خطا در اتصال به دیتابیس";
                return;
            }

            if (data && data.high_price) {
                // Assuming stored price is in Rials, convert to Tomans by dividing by 10
                const priceInTomans = data.high_price / 10;
                
                if (priceInTomans > 0) {
                    const weight = principal / priceInTomans;
                    weightInput.value = weight.toFixed(3);
                    
                    // Show which date was used if different from requested
                    if (data.date_jalali !== dateStr) {
                        if(msgEl) msgEl.innerText = `قیمت ${data.date_jalali}: ${formatNumber(priceInTomans)} تومان`;
                    } else {
                        if(msgEl) msgEl.innerText = `قیمت ${dateStr}: ${formatNumber(priceInTomans)} تومان`;
                    }
                    
                    showToast(`محاسبه شد: ${weight.toFixed(3)} گرم`);
                }
            } else {
                 if(msgEl) msgEl.innerText = `قیمتی برای ${dateStr} یافت نشد`;
            }
        } catch (e) {
            console.error(e);
            if(msgEl) msgEl.innerText = "خطا در محاسبه";
        } finally {
            weightInput.placeholder = originalPlaceholder;
        }
    }

    // --- DB Operations (NEW) ---
    async function fetchLoansDB() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        const { data, error } = await sb
            .from('loans')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error fetching loans:', error);
            alert('خطا در دریافت اطلاعات وام‌ها');
            return;
        }

        // Map DB columns to UI expected format (CamelCase)
        loans = data.map(row => ({
            id: row.id,
            bank: row.bank_name,
            borrower: row.borrower_name,
            principal: row.principal_amount,
            totalRepayment: row.total_repayment,
            installmentsTotal: row.installments_total,
            startDate: row.start_date,
            repaymentInterval: row.repayment_interval || 1,
            payments: row.payments || [],
            
            // New mappings
            goldWeight: row.gold_weight || 0,
            gracePeriod: row.grace_period || 0,
            firstInstallmentDate: row.first_installment_date || row.start_date, 
            repaymentType: row.repayment_type || 'monthly',

            // NEW FIELDS ADDED HERE
            loanNumber: row.loan_number || '',
            loanCardNumber: row.loan_card_number || '',
            loanShabaNumber: row.loan_shaba_number || ''
        }));

        window.updateAllLoans();
    }

    async function deleteLoanDB(id) {
        if (!confirm('این وام حذف شود؟')) return;

        const { error } = await sb
            .from('loans')
            .delete()
            .eq('id', id);

        if (error) {
            alert('خطا در حذف وام');
            console.error(error);
        } else {
            fetchLoansDB();
            if (editingLoanId === id) cancelEditMode();
        }
    }

    async function updateLoanPaymentsDB(loanId, newPaymentsArray) {
        const { error } = await sb
            .from('loans')
            .update({ payments: newPaymentsArray })
            .eq('id', loanId);

        if (error) {
            console.error('Error updating payments:', error);
            alert('خطا در ثبت وضعیت پرداخت');
        } else {
            fetchLoansDB(); // Refresh to sync everything
        }
    }

    // --- Core Logic ---
    function syncDates(source) {
        const startEl = document.getElementById('startDate');
        const graceEl = document.getElementById('gracePeriod');
        const firstEl = document.getElementById('firstInstallmentDate');
        const typeEl = document.getElementById('repaymentType');
        const intervalEl = document.getElementById('repaymentInterval');

        const startDate = parseJalaliString(startEl.value);
        let grace = parseInt(graceEl.value) || 0;
        let duration = parseInt(intervalEl.value) || 0;

        if (source === 'start' || source === 'grace' || source === 'interval' || source === 'type') {
            let offset = grace + 1; 
            if (typeEl && typeEl.value === 'mudaraba') {
                if (duration > 0) offset = duration + grace;
            }
            const newDate = addMonthsToJalali(startDate, offset);
            firstEl.value = formatJalaliDate(newDate);
        } else if (source === 'first') {
            const monthsDiff = diffInMonths(startEl.value, firstEl.value);
            if (typeEl && typeEl.value === 'mudaraba') {
                intervalEl.value = monthsDiff > 0 ? monthsDiff : 1;
            } else {
                let calcGrace = monthsDiff - 1;
                if (calcGrace < 0) calcGrace = 0;
                graceEl.value = calcGrace;
            }
        }
    }

    window.updateAllLoans = function() {
        renderLoans();
        renderCalendarWidget();
        renderOverdueSection();
        updateSummary();
    };

    // --- DOM Interaction ---
    function toggleRepaymentFields() {
        const type = document.getElementById('repaymentType').value;
        const intervalGroup = document.getElementById('intervalGroup');
        const installmentsGroup = document.getElementById('installmentsCountGroup');
        const intervalInput = document.getElementById('repaymentInterval');
        const intervalLabel = document.getElementById('intervalLabel');
        const installmentsInput = document.getElementById('installmentsTotal');

        if (type === 'monthly') {
            intervalGroup.classList.add('hidden');
            installmentsGroup.classList.remove('hidden');
            intervalInput.value = 1; intervalInput.required = false;
        } else if (type === 'interval') {
            intervalGroup.classList.remove('hidden');
            installmentsGroup.classList.remove('hidden');
            intervalLabel.innerText = "فاصله اقساط (ماه)";
            intervalInput.value = ""; intervalInput.placeholder = "مثلاً 3"; intervalInput.required = true;
        } else if (type === 'mudaraba') {
            intervalGroup.classList.remove('hidden');
            installmentsGroup.classList.add('hidden');
            installmentsInput.value = 1;
            intervalLabel.innerText = "مدت قرارداد (ماه)";
            intervalInput.placeholder = "مثلاً 12"; intervalInput.value = ""; intervalInput.required = true;
        }
    }

    function editLoan(id) {
        const loan = loans.find(l => l.id === id);
        if (!loan) return;
        editingLoanId = id;
        document.getElementById('bankName').value = loan.bank;
        document.getElementById('borrower').value = loan.borrower;
        const pEl = document.getElementById('principalAmount'); pEl.value = loan.principal; formatInput(pEl);
        const tEl = document.getElementById('totalRepayment'); tEl.value = loan.totalRepayment; formatInput(tEl);
        document.getElementById('goldWeight').value = loan.goldWeight;
        document.getElementById('repaymentType').value = loan.repaymentType || 'monthly';
        toggleRepaymentFields();
        document.getElementById('installmentsTotal').value = loan.installmentsTotal;
        document.getElementById('repaymentInterval').value = loan.repaymentInterval;
        document.getElementById('startDate').value = loan.startDate;
        document.getElementById('gracePeriod').value = loan.gracePeriod;
        document.getElementById('firstInstallmentDate').value = loan.firstInstallmentDate || '';
        
        // Populate new fields
        document.getElementById('loanNumber').value = loan.loanNumber || '';
        
        // Apply value AND format
        const cardEl = document.getElementById('loanCardNumber');
        cardEl.value = loan.loanCardNumber || '';
        formatCardNumber(cardEl);
        
        const shabaEl = document.getElementById('loanShabaNumber');
        shabaEl.value = loan.loanShabaNumber || '';
        formatShabaNumber(shabaEl);

        if(!document.getElementById('firstInstallmentDate').value) syncDates('start');

        document.getElementById('formCard').classList.add('border-blue-300', 'bg-blue-50');
        document.getElementById('formTitle').innerText = 'ویرایش اطلاعات وام';
        document.getElementById('btnSubmit').innerText = 'ذخیره تغییرات';
        document.getElementById('btnCancelEdit').classList.remove('hidden');
        document.getElementById('formCard').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEditMode() {
        editingLoanId = null;
        document.getElementById('loanForm').reset();
        document.getElementById('startDate').value = formatJalaliDate(getTodayJalali());
        document.getElementById('repaymentType').value = 'monthly';
        toggleRepaymentFields();
        syncDates('start');
        
        // Reset validation styles
        document.getElementById('cardWrapper').classList.remove('valid');
        document.getElementById('shabaWrapper').classList.remove('valid');

        document.getElementById('formCard').classList.remove('border-blue-300', 'bg-blue-50');
        document.getElementById('formTitle').innerText = 'ثبت تسهیلات جدید';
        document.getElementById('btnSubmit').innerText = 'ثبت وام در سیستم';
        document.getElementById('btnCancelEdit').classList.add('hidden');
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        
        const { data: { user } } = await sb.auth.getUser();
        if (!user) { alert('لطفا وارد شوید'); return; }

        const type = document.getElementById('repaymentType').value;
        let installmentsTotal = parseInt(document.getElementById('installmentsTotal').value);
        let interval = parseInt(document.getElementById('repaymentInterval').value) || 1;
        if (type === 'mudaraba') installmentsTotal = 1; else if (type === 'monthly') interval = 1;

        // DB Object strictly matching provided schema and now including new fields
        const loanDBData = {
            user_id: user.id,
            user_email: user.email,
            bank_name: document.getElementById('bankName').value,
            borrower_name: document.getElementById('borrower').value,
            principal_amount: getRawValue(document.getElementById('principalAmount').value),
            total_repayment: getRawValue(document.getElementById('totalRepayment').value),
            installments_total: installmentsTotal,
            start_date: document.getElementById('startDate').value || formatJalaliDate(getTodayJalali()),
            repayment_interval: interval,
            
            // New Fields being saved
            gold_weight: document.getElementById('goldWeight').value || 0,
            first_installment_date: document.getElementById('firstInstallmentDate').value,
            grace_period: parseInt(document.getElementById('gracePeriod').value) || 0,
            repayment_type: document.getElementById('repaymentType').value,

            // NEW DB COLUMNS - STRIP DASHES
            loan_number: document.getElementById('loanNumber').value,
            loan_card_number: document.getElementById('loanCardNumber').value.replace(/-/g, ''),
            loan_shaba_number: document.getElementById('loanShabaNumber').value.replace(/-/g, '')
        };

        let error = null;

        if (editingLoanId) {
            const res = await sb
                .from('loans')
                .update(loanDBData)
                .eq('id', editingLoanId);
            error = res.error;
        } else {
            // New loan
            const res = await sb
                .from('loans')
                .insert([loanDBData]);
            error = res.error;
        }

        if (error) {
            console.error(error);
            showToast('خطا در ذخیره اطلاعات: ' + error.message, 'error');
        } else {
            fetchLoansDB();
            const action = editingLoanId ? 'ویرایش' : 'ثبت';
            showToast(`وام با موفقیت ${action} شد`);
            cancelEditMode();
        }
    }

    // --- Modal & Payment Logic ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function initiatePayment(loanId, installmentNum) {
        document.getElementById('pendingPaymentLoanId').value = loanId;
        document.getElementById('pendingPaymentInstallmentNum').value = installmentNum;
        document.getElementById('confirmPaymentDate').value = formatJalaliDate(getTodayJalali());
        openModal('paymentDateModal');
    }

    async function confirmPayment() {
        const loanId = parseInt(document.getElementById('pendingPaymentLoanId').value);
        const installmentNum = parseInt(document.getElementById('pendingPaymentInstallmentNum').value);
        const dateStr = document.getElementById('confirmPaymentDate').value;
        
        // Find local copy to append payment, then save whole array
        const loan = loans.find(l => l.id === loanId);
        if (loan) {
            const currentPayments = loan.payments || [];
            const existingIdx = currentPayments.findIndex(p => p.num === installmentNum);
            
            if (existingIdx === -1) {
                currentPayments.push({ num: installmentNum, date: dateStr });
                currentPayments.sort((a,b) => a.num - b.num);
                
                // Update DB
                await updateLoanPaymentsDB(loanId, currentPayments);
                
                closeModal('paymentDateModal');
                if (document.getElementById('historyModal').style.display === 'flex') {
                    // Slight delay to allow fetch to complete
                    setTimeout(() => showHistory(loanId), 500);
                }
            }
        } else {
            closeModal('paymentDateModal');
        }
    }

    async function removePayment(loanId, installmentNum) {
        if (!confirm('آیا از حذف وضعیت پرداخت این قسط اطمینان دارید؟')) return;
        
        const loan = loans.find(l => l.id === loanId);
        if (loan) {
            const currentPayments = loan.payments || [];
            const newPayments = currentPayments.filter(p => p.num !== installmentNum);
            
            await updateLoanPaymentsDB(loanId, newPayments);
            
            if (document.getElementById('historyModal').style.display === 'flex') {
                 setTimeout(() => showHistory(loanId), 500);
            }
        }
    }

    // --- Rendering ---
    function showHistory(loanId) {
        // Re-find loan from (potentially updated) loans array
        const loan = loans.find(l => l.id === loanId);
        if(!loan) return;
        const container = document.getElementById('historyModalContent');
        container.innerHTML = '';
        const installmentAmount = Math.round(loan.totalRepayment / loan.installmentsTotal);
        const todayStr = formatJalaliDate(getTodayJalali());

        for(let i=1; i<=loan.installmentsTotal; i++) {
            const dueDateObj = calculateInstallmentDateV2(loan.firstInstallmentDate, i, loan.repaymentInterval);
            const dueDateStr = formatJalaliDate(dueDateObj);
            const payment = (loan.payments || []).find(p => p.num === i);
            const isPaid = !!payment;
            let statusClass = "bg-slate-50 border-slate-200";
            let statusText = "";
            let actionBtn = "";
            
            if (isPaid) {
                statusClass = "bg-emerald-50 border-emerald-200";
                statusText = `<span class="text-emerald-600 font-bold text-xs">پرداخت شده (${payment.date})</span>`;
                actionBtn = `<button onclick="removePayment(${loan.id}, ${i})" class="text-xs text-red-400 hover:text-red-600 px-2">لغو</button>`;
            } else {
                if (compareJalaliDates(dueDateStr, todayStr) < 0) {
                    statusClass = "bg-red-50 border-red-200";
                    statusText = `<span class="text-red-600 font-bold text-xs">معوق (${dueDateStr})</span>`;
                    actionBtn = `<button onclick="initiatePayment(${loan.id}, ${i})" class="text-xs bg-red-100 text-red-700 border border-red-200 px-3 py-1.5 rounded hover:bg-red-200 font-bold">تایید</button>`;
                } else {
                    statusText = `<span class="text-slate-400 text-xs">سررسید: ${dueDateStr}</span>`;
                    actionBtn = `<button onclick="initiatePayment(${loan.id}, ${i})" class="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-200 font-bold">پرداخت</button>`;
                }
            }
            container.innerHTML += `
                <div class="flex justify-between items-center p-3 rounded border ${statusClass} mb-2">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${isPaid ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-500'}">${i}</div>
                        <div><div class="font-mono text-sm font-bold text-slate-700">${formatNumber(installmentAmount)}</div><div>${statusText}</div></div>
                    </div>
                    <div>${actionBtn}</div>
                </div>`;
        }
        openModal('historyModal');
    }

    function renderOverdueSection() {
        const container = document.getElementById('overdueList');
        const section = document.getElementById('overdueSection');
        const totalBadge = document.getElementById('overdueTotalBadge');
        const summaryText = document.getElementById('overdueSummaryText');
        
        const todayStr = formatJalaliDate(getTodayJalali());
        
        container.innerHTML = '';
        let overdueCount = 0;
        let totalOverdueAmount = 0;

        loans.forEach(loan => {
            const installmentAmount = Math.round(loan.totalRepayment / loan.installmentsTotal);
            for(let i=1; i<=loan.installmentsTotal; i++) {
                if ((loan.payments || []).find(p => p.num === i)) continue;
                const dueDateObj = calculateInstallmentDateV2(loan.firstInstallmentDate, i, loan.repaymentInterval);
                const dueDateStr = formatJalaliDate(dueDateObj);
                if (compareJalaliDates(dueDateStr, todayStr) < 0) {
                    overdueCount++;
                    totalOverdueAmount += installmentAmount;
                    container.innerHTML += `
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-3 rounded border border-red-100 shadow-sm mb-2 gap-2">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full bg-red-500 shrink-0"></div>
                                <div><div class="text-sm font-bold text-slate-700">${loan.bank}</div><div class="text-xs text-red-600">قسط ${i} - ${dueDateStr}</div></div>
                            </div>
                            <div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-end">
                                <span class="font-mono text-sm font-bold text-slate-700">${formatNumber(installmentAmount)}</span>
                                <button onclick="initiatePayment(${loan.id}, ${i})" class="bg-red-50 text-red-600 hover:bg-red-100 text-xs px-3 py-1.5 rounded font-bold transition">تایید</button>
                            </div>
                        </div>`;
                }
            }
        });
        
        if(overdueCount > 0) { 
            section.classList.remove('hidden'); 
            totalBadge.innerText = `${overdueCount} مورد`;
            summaryText.innerText = `${overdueCount} قسط به مبلغ کل ${formatNumber(totalOverdueAmount)} تومان`;
        } 
        else { 
            section.classList.add('hidden'); 
        }
    }

    function renderLoans() {
        const container = document.getElementById('loansList');
        const globalPrice = getRawValue(document.getElementById('globalGoldPrice').value);
        if (loans.length === 0) {
            container.innerHTML = `<div class="text-center text-slate-400 py-12 bg-white rounded-2xl border-2 border-dashed border-slate-200">هنوز وامی ثبت نشده است.</div>`;
            return;
        }
        container.innerHTML = '';
        loans.forEach(loan => {
            const paidCount = (loan.payments || []).length;
            const installmentAmount = Math.round(loan.totalRepayment / loan.installmentsTotal);
            const paidAmount = paidCount * installmentAmount;
            const remainingDebt = loan.totalRepayment - paidAmount;
            const currentAssetValue = (loan.goldWeight || 0) * globalPrice;
            const breakEvenRatio = loan.totalRepayment > 0 ? (currentAssetValue / loan.totalRepayment) * 100 : 0;
            const isBreakEven = currentAssetValue >= loan.totalRepayment;
            const breakEvenColor = isBreakEven ? 'bg-emerald-500' : 'bg-red-500';
            const breakEvenText = isBreakEven ? 'سودده' : 'ریسک';
            const breakEvenTextColor = isBreakEven ? 'text-emerald-700' : 'text-red-700';

            let nextDueStr = "تسویه";
            for(let i=1; i<=loan.installmentsTotal; i++) {
                if (!(loan.payments || []).find(p => p.num === i)) {
                    const next = calculateInstallmentDateV2(loan.firstInstallmentDate, i, loan.repaymentInterval);
                    nextDueStr = formatJalaliDate(next);
                    break;
                }
            }
            
            let typeStr = "ماهانه";
            if (loan.repaymentType === 'mudaraba') typeStr = `مضاربه (${loan.repaymentInterval} ماه)`;
            else if (loan.repaymentType === 'interval') typeStr = `هر ${loan.repaymentInterval} ماه`;

            container.innerHTML += `
                <div class="bg-white rounded-2xl p-4 md:p-5 card-shadow border ${loan.id===editingLoanId?'border-blue-400':'border-slate-100'} relative overflow-hidden transition hover:shadow-lg mb-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-2">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-50 p-2 rounded-lg text-blue-700 font-bold text-xl w-12 h-12 flex items-center justify-center border border-blue-100 shrink-0">${(loan.bank || '').substring(0,2)}</div>
                            <div><h3 class="font-bold text-slate-800 text-lg">${loan.bank}</h3><p class="text-xs text-slate-500">${loan.borrower} | ${typeStr}</p></div>
                        </div>
                        <div class="text-right sm:text-left w-full sm:w-auto flex flex-row sm:flex-col justify-between sm:justify-start items-center sm:items-end border-t sm:border-0 pt-2 sm:pt-0 border-slate-50 mt-2 sm:mt-0">
                            <div class="text-xs text-slate-400">بعدی: <span class="text-indigo-600 font-bold">${nextDueStr}</span></div>
                            <div class="font-bold text-slate-700 font-mono text-lg mt-0 sm:mt-1">${formatNumber(installmentAmount)} <span class="text-[10px] font-normal">T</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div><span class="block text-[10px] text-slate-400">کل بازپرداخت</span><span class="block font-bold text-slate-800 text-sm font-mono">${formatNumber(loan.totalRepayment)}</span></div>
                        <div><span class="block text-[10px] text-slate-400">مانده بدهی</span><span class="block font-bold text-red-600 text-sm font-mono">${formatNumber(remainingDebt)}</span></div>
                        <div><span class="block text-[10px] text-slate-400">وزن طلا</span><span class="block font-bold text-amber-600 text-sm ltr text-right font-mono">${loan.goldWeight || 0} g</span></div>
                        <div><span class="block text-[10px] text-slate-400">ارزش روز</span><span class="block font-bold text-emerald-600 text-sm font-mono">${formatNumber(currentAssetValue)}</span></div>
                    </div>
                    <div class="mb-5"><div class="flex justify-between text-xs mb-1"><span class="font-bold text-slate-600">پیشرفت (${paidCount}/${loan.installmentsTotal})</span></div><div class="status-bar-bg"><div class="status-bar-fill bg-blue-500" style="width: ${(paidCount/loan.installmentsTotal)*100}%"></div></div></div>
                    <div class="mb-4"><div class="flex justify-between text-xs mb-1"><span class="font-bold text-slate-600">وضعیت سر به سر</span><span class="font-bold ${breakEvenTextColor}">${breakEvenText}</span></div><div class="status-bar-bg border border-slate-200"><div class="status-bar-fill ${breakEvenColor}" style="width: ${Math.min(breakEvenRatio, 100)}%"></div></div></div>
                    <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                        <div class="flex gap-2"><button onclick="editLoan(${loan.id})" class="text-xs text-slate-500 bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded transition">ویرایش</button><button onclick="deleteLoanDB(${loan.id})" class="text-xs text-red-400 hover:text-red-600 px-3 py-1">حذف</button></div>
                        <button onclick="showHistory(${loan.id})" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs font-bold px-4 py-2 rounded-lg transition flex items-center gap-2">مشاهده وضعیت</button>
                    </div>
                </div>`;
        });
    }

    function updateSummary() {
        const globalPrice = getRawValue(document.getElementById('globalGoldPrice').value);
        let totalDebt = 0;
        let totalAssetValue = 0;
        loans.forEach(loan => {
            const installmentAmount = Math.round(loan.totalRepayment / loan.installmentsTotal);
            const paidAmount = (loan.payments || []).length * installmentAmount;
            totalDebt += (loan.totalRepayment - paidAmount);
            totalAssetValue += ((loan.goldWeight || 0) * globalPrice);
        });
        document.getElementById('sumRemainingDebt').innerText = formatNumber(totalDebt);
        document.getElementById('sumAssetValue').innerText = formatNumber(totalAssetValue);
    }

    // --- Calendar ---
    const MONTH_NAMES = ["", "فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
    function initCalendar() { 
        const today = getTodayJalali();
        calYear = today.jy; 
        calMonth = today.jm; 
        renderCalendarWidget(); 
        selectDate(calYear, calMonth, today.jd); 
    }
    
    function changeMonth(delta) { 
        calMonth += delta; 
        if(calMonth>12){calMonth=1;calYear++} 
        if(calMonth<1){calMonth=12;calYear--} 
        renderCalendarWidget(); 
    }

    function renderCalendarWidget() {
        document.getElementById('calendarMonthTitle').innerText = `${MONTH_NAMES[calMonth]} ${calYear}`;
        document.getElementById('summaryMonthName').innerText = `${MONTH_NAMES[calMonth]} ${calYear}`;
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        
        let monthlyTotal = 0;
        const eventsMap = {};
        
        loans.forEach(loan => {
            for(let i=1; i<=loan.installmentsTotal; i++) {
                if ((loan.payments || []).find(p => p.num === i)) continue; 
                const date = calculateInstallmentDateV2(loan.firstInstallmentDate, i, loan.repaymentInterval);
                if (date.jy === calYear && date.jm === calMonth) {
                    const dateStr = formatJalaliDate(date);
                    if (!eventsMap[dateStr]) eventsMap[dateStr] = [];
                    const amount = Math.round(loan.totalRepayment / loan.installmentsTotal);
                    monthlyTotal += amount;
                    eventsMap[dateStr].push({ ...loan, amount });
                }
            }
        });
        
        document.getElementById('sumMonthlyDue').innerText = formatNumber(monthlyTotal) + " T";
        
        const daysInMonth = jalaali.jalaaliMonthLength(calYear, calMonth);
        const gDate = jalaali.toGregorian(calYear, calMonth, 1);
        let dayOfWeek = new Date(gDate.gy, gDate.gm-1, gDate.gd).getDay() + 1;
        if(dayOfWeek===7) dayOfWeek=0;
        
        for(let i=0; i<dayOfWeek; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'calendar-day empty'}));
        
        const today = getTodayJalali();
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${calYear}/${String(calMonth).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
            const events = eventsMap[dateStr] || [];
            const dayEl = document.createElement('div');
            dayEl.className = `calendar-day ${calYear===today.jy && calMonth===today.jm && d===today.jd ? 'today' : ''}`;
            dayEl.onclick = () => selectDate(calYear, calMonth, d);
            dayEl.innerHTML = `<span>${d}</span>${events.length ? `<div class="event-badge">${events.length}</div>` : ''}`;
            grid.appendChild(dayEl);
        }
    }

    function selectDate(y, m, d) {
        const grid = document.getElementById('calendarGrid');
        grid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
        const dateStr = `${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
        document.getElementById('selectedDateTitle').innerText = dateStr;
        
        let total = 0;
        const list = document.getElementById('selectedDateList');
        list.innerHTML = '';
        
        loans.forEach(loan => {
            for(let i=1; i<=loan.installmentsTotal; i++) {
                if ((loan.payments || []).find(p => p.num === i)) continue; 
                const date = calculateInstallmentDateV2(loan.firstInstallmentDate, i, loan.repaymentInterval);
                const dStr = formatJalaliDate(date);
                if (dStr === dateStr) {
                    const amount = Math.round(loan.totalRepayment / loan.installmentsTotal);
                    total += amount;
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100 mb-1">
                            <div><div class="text-xs font-bold text-slate-700">${loan.bank}</div><div class="text-[10px] text-slate-500">${loan.borrower}</div></div>
                            <div class="font-mono text-xs font-bold text-slate-600">${formatNumber(amount)}</div>
                        </div>`;
                }
            }
        });
        
        if (list.innerHTML === '') list.innerHTML = `<div class="text-xs text-slate-400 text-center py-2">هیچ قسطی نیست.</div>`;
        document.getElementById('selectedDateTotal').innerText = formatNumber(total) + " T";
        document.getElementById('selectedDatePanel').classList.remove('hidden');
    }

    // --- Boot ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof jalaali === 'undefined') {
            alert('خطا: کتابخانه تاریخ بارگذاری نشد.');
            return;
        }

        const today = getTodayJalali();
        document.getElementById('startDate').value = formatJalaliDate(today);
        syncDates('start');
        toggleRepaymentFields();
        
        const form = document.getElementById('loanForm');
        if(form) form.addEventListener('submit', handleFormSubmit);
        
        // Initial Fetch
        fetchLoansDB();
        initCalendar();
        fetchLiveGoldPrice();
    });

    // --- Date Picker Logic (New) ---
    let pickerTargetId = null;
    let pickerYear = 1403;
    let pickerMonth = 1;

    function openDatePicker(inputId) {
        pickerTargetId = inputId;
        const currentVal = document.getElementById(inputId).value;
        const today = getTodayJalali();
        
        if(currentVal && currentVal.length >= 8) {
            const parts = parseJalaliString(currentVal);
            pickerYear = parts.jy;
            pickerMonth = parts.jm;
        } else {
            pickerYear = today.jy;
            pickerMonth = today.jm;
        }
        
        renderDatePicker();
        document.getElementById('datePickerModal').style.display = 'flex';
    }

    function changePickerMonth(delta) {
        pickerMonth += delta;
        if(pickerMonth > 12) { pickerMonth = 1; pickerYear++; }
        if(pickerMonth < 1) { pickerMonth = 12; pickerYear--; }
        renderDatePicker();
    }

    function renderDatePicker() {
        document.getElementById('pickerTitle').innerText = `${MONTH_NAMES[pickerMonth]} ${pickerYear}`;
        const grid = document.getElementById('pickerGrid'); 
        grid.innerHTML = '';
        
        const daysInMonth = jalaali.jalaaliMonthLength(pickerYear, pickerMonth);
        const gDate = jalaali.toGregorian(pickerYear, pickerMonth, 1);
        let dayOfWeek = new Date(gDate.gy, gDate.gm-1, gDate.gd).getDay() + 1;
        if(dayOfWeek === 7) dayOfWeek = 0;
        
        for(let i=0; i<dayOfWeek; i++) grid.appendChild(Object.assign(document.createElement('div'), {className:'calendar-day empty'}));
        
        const today = getTodayJalali();
        const currentVal = document.getElementById(pickerTargetId).value;
        const currentParts = (currentVal && currentVal.length >= 8) ? parseJalaliString(currentVal) : null;

        for(let d=1; d<=daysInMonth; d++) {
            const dayEl = document.createElement('div');
            const isToday = (pickerYear===today.jy && pickerMonth===today.jm && d===today.jd);
            const isSelected = (currentParts && pickerYear===currentParts.jy && pickerMonth===currentParts.jm && d===currentParts.jd);
            
            dayEl.className = `calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}`;
            dayEl.onclick = () => selectPickerDate(pickerYear, pickerMonth, d);
            dayEl.innerHTML = `<span>${d}</span>`;
            grid.appendChild(dayEl);
        }
    }

    function selectPickerDate(y, m, d) {
        const formatted = `${y}/${String(m).padStart(2,'0')}/${String(d).padStart(2,'0')}`;
        const input = document.getElementById(pickerTargetId);
        input.value = formatted;
        
        // Trigger change event manually so syncDates works
        input.dispatchEvent(new Event('change'));
        
        closeModal('datePickerModal');
    }

</script>
</body>
</html>