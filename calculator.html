<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุงุดู ุญุณุงุจ ุญุฑููโุง ุขุฑุจุชุฑุงฺ ุทูุง (ุณุจุฏ ุฏุงุฑุง)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- AUTHENTICATION (LOCKED) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script>
        // Protect this page
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof checkAuthGuard === 'function') {
                checkAuthGuard();
            }
        });
    </script>

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .currency-badge { 
            position: absolute; 
            left: 8px; 
            top: 50%; 
            transform: translateY(-50%); 
            font-size: 0.7rem; 
            color: #64748b; 
            pointer-events: none;
        }
        .input-row input { padding-left: 2.5rem; }
        .compact-input { padding: 0.5rem; font-size: 0.9rem; }
        
        /* Tab Animations */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .step-connector {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            height: 1.5rem;
            border-left: 2px dashed #cbd5e1;
            z-index: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">

    <!-- Main Container -->
    <div class="w-full max-w-6xl bg-white rounded-2xl card-shadow overflow-hidden flex flex-col min-h-[80vh]">
        
        <!-- Header -->
        <header class="bg-slate-900 text-white p-4 md:p-6 text-center relative overflow-hidden flex-shrink-0">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            
            <div class="absolute top-4 left-4 z-20 flex gap-2">
                <a href="index.html" class="text-xs bg-slate-600/80 hover:bg-slate-500 text-white px-3 py-1.5 rounded-lg transition backdrop-blur-sm border border-slate-500/50 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    <span class="hidden sm:inline">ุฎุงูู</span>
                </a>
                <button onclick="if(typeof signOut === 'function') signOut()" class="text-xs bg-red-600/80 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg transition backdrop-blur-sm border border-red-500/50 flex items-center gap-1">ุฎุฑูุฌ</button>
            </div>

            <h1 class="text-xl md:text-2xl font-bold relative z-10 text-amber-400">ูุงุดู ุญุณุงุจ ุงุณุชุฑุงุชฺ ุทูุง</h1>
            <p class="text-slate-300 text-xs md:text-sm mt-2 relative z-10">ูุฏุฑุช ุณุจุฏ ูุฑูุด ู ุขุฑุจุชุฑุงฺ ุญุฑุงุฌ ุณฺฉู</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="flex border-b border-slate-200 bg-slate-50">
            <button onclick="switchTab('simple')" id="tabBtn-simple" class="flex-1 py-4 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:bg-slate-100 transition-colors active-tab">
                ๐งฎ ุชุจุฏู ูุญุธูโุง (ุณุงุฏู)
            </button>
            <button onclick="switchTab('auction')" id="tabBtn-auction" class="flex-1 py-4 text-sm font-bold text-indigo-600 border-b-2 border-transparent hover:bg-indigo-50 transition-colors">
                โ๏ธ ุงุณุชุฑุงุชฺ ุญุฑุงุฌ (ูุฑฺฉุจ)
            </button>
        </div>

        <div class="p-4 md:p-6 flex-1 bg-slate-50/50 overflow-y-auto">
            
            <!-- TAB 1: SIMPLE CALCULATOR (Existing Code) -->
            <div id="tab-simple" class="tab-content active">
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
                    <!-- Side A: Selling -->
                    <div class="bg-white rounded-xl border border-red-100 shadow-sm relative group">
                        <div class="bg-red-50 p-3 rounded-t-xl border-b border-red-100 flex justify-between items-center">
                            <span class="font-bold text-red-800 flex items-center gap-2">๐ป ุณุจุฏ ูุฑูุด (ุฏุงุฑุง ููุฌูุฏ)</span>
                        </div>
                        <div class="p-4 space-y-3">
                            <div class="grid grid-cols-12 gap-2 text-xs text-red-700 font-bold mb-1 px-1">
                                <div class="col-span-4">ููุน ุฏุงุฑุง</div>
                                <div class="col-span-3 text-center">ุชุนุฏุงุฏ / ฺฏุฑู</div>
                                <div class="col-span-5 text-center">ู ูุฑูุด (ุชููุงู)</div>
                            </div>
                            <!-- Rows -->
                            <div class="grid grid-cols-12 gap-2 items-center bg-slate-50 p-2 rounded border border-slate-100">
                                <div class="col-span-4 text-sm font-medium text-slate-700">ุชูุงู ุณฺฉู</div>
                                <div class="col-span-3"><input type="number" id="qtyFull" placeholder="0" class="w-full compact-input border rounded text-center focus:ring-1 ring-red-300 outline-none" oninput="calculateSimple()"></div>
                                <div class="col-span-5 relative input-row"><input type="text" inputmode="numeric" id="priceFull" value="147,000,000" class="w-full compact-input border rounded focus:ring-1 ring-red-300 outline-none text-left ltr" oninput="formatInput(this); calculateSimple()"></div>
                            </div>
                            <div class="grid grid-cols-12 gap-2 items-center bg-slate-50 p-2 rounded border border-slate-100">
                                <div class="col-span-4 text-sm font-medium text-slate-700">ูู ุณฺฉู</div>
                                <div class="col-span-3"><input type="number" id="qtyHalf" value="30" placeholder="0" class="w-full compact-input border rounded text-center focus:ring-1 ring-red-300 outline-none" oninput="calculateSimple()"></div>
                                <div class="col-span-5 relative input-row"><input type="text" inputmode="numeric" id="priceHalf" value="82,500,000" class="w-full compact-input border rounded focus:ring-1 ring-red-300 outline-none text-left ltr" oninput="formatInput(this); calculateSimple()"></div>
                            </div>
                            <div class="grid grid-cols-12 gap-2 items-center bg-slate-50 p-2 rounded border border-slate-100">
                                <div class="col-span-4 text-sm font-medium text-slate-700">ุฑุจุน ุณฺฉู</div>
                                <div class="col-span-3"><input type="number" id="qtyQuarter" value="2" placeholder="0" class="w-full compact-input border rounded text-center focus:ring-1 ring-red-300 outline-none" oninput="calculateSimple()"></div>
                                <div class="col-span-5 relative input-row"><input type="text" inputmode="numeric" id="priceQuarter" value="52,000,000" class="w-full compact-input border rounded focus:ring-1 ring-red-300 outline-none text-left ltr" oninput="formatInput(this); calculateSimple()"></div>
                            </div>
                            <div class="grid grid-cols-12 gap-2 items-center bg-yellow-50 p-2 rounded border border-yellow-200">
                                <div class="col-span-4 text-sm font-medium text-yellow-800">ุขุจุดุฏู (ฑธ ุนุงุฑ)</div>
                                <div class="col-span-3 relative">
                                    <input type="number" id="qtyMelted" placeholder="0" class="w-full compact-input border rounded text-center focus:ring-1 ring-yellow-300 outline-none border-yellow-300">
                                    <span class="absolute left-1 top-1/2 -translate-y-1/2 text-[0.6rem] text-yellow-600">ฺฏุฑู</span>
                                </div>
                                <div class="col-span-5 relative input-row"><input type="text" inputmode="numeric" id="priceMelted" placeholder="ู" class="w-full compact-input border rounded focus:ring-1 ring-yellow-300 outline-none border-yellow-300 text-left ltr" oninput="formatInput(this); calculateSimple()"></div>
                            </div>
                            <div class="mt-4 pt-3 border-t border-red-200 flex justify-between items-center">
                                <span class="text-sm text-red-800 font-bold">ูุฌููุน ููุฏูฺฏ:</span>
                                <span id="totalCashSimple" class="font-black text-xl text-red-900">0 ุชููุงู</span>
                            </div>
                        </div>
                    </div>

                    <!-- Side B: Buying -->
                    <div class="bg-white rounded-xl border border-emerald-100 shadow-sm relative group flex flex-col">
                        <div class="bg-emerald-50 p-3 rounded-t-xl border-b border-emerald-100 flex justify-between items-center">
                            <span class="font-bold text-emerald-800 flex items-center gap-2">โ ุฎุฑุฏ (ูุฏู)</span>
                        </div>
                        <div class="p-6 space-y-6 flex-1 flex flex-col justify-center">
                            <div>
                                <label class="block text-sm font-bold text-emerald-800 mb-2">ูุตุฏ ุฎุฑุฏ ฺู ฺุฒ ุฑุง ุฏุงุฑุฏุ</label>
                                <select id="buyTypeSimple" class="w-full p-3 rounded-lg border-emerald-200 border outline-none bg-slate-50" onchange="calculateSimple()">
                                    <option value="melted">ุทูุง ุขุจุดุฏู (ุฎุงู ฑธ ุนุงุฑ)</option>
                                    <option value="full" selected>ุชูุงู ุณฺฉู</option>
                                    <option value="half">ูู ุณฺฉู</option>
                                    <option value="quarter">ุฑุจุน ุณฺฉู</option>
                                </select>
                            </div>
                            <div class="relative">
                                <label class="block text-sm font-bold text-emerald-800 mb-2" id="buyPriceLabelSimple">ููุช ุฎุฑุฏ (ุชููุงู)</label>
                                <div class="relative">
                                    <input type="text" inputmode="numeric" id="buyPriceSimple" value="147,000,000" class="w-full p-4 pl-16 rounded-xl border border-emerald-300 text-xl font-bold text-emerald-900 ltr" oninput="formatInput(this); calculateSimple()">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-500 font-medium">Toman</span>
                                </div>
                            </div>
                            <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-200 mt-auto">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm text-emerald-800 font-bold">ููุฏุงุฑ ูุงุจู ุฎุฑุฏ:</span>
                                    <span id="buyCountDisplaySimple" class="font-black text-2xl text-emerald-900">0</span>
                                </div>
                                <div class="flex justify-between items-center text-xs text-emerald-600 mt-2 pt-2 border-t border-emerald-100">
                                    <span>ุจุงูโูุงูุฏู ูพูู:</span>
                                    <span id="cashRemainsSimple">0 ุชููุงู</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Result & Chart Simple -->
                <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                        <div class="md:col-span-1 space-y-4">
                            <div id="resultCardSimple" class="p-4 rounded-xl border text-center bg-slate-100 transition-colors duration-300">
                                <div class="text-xs text-slate-500 mb-1 font-medium">ุชุบุฑ ุฎุงูุต ูุฒู (ุนุงุฑ นฐฐ)</div>
                                <div id="netWeightValSimple" class="text-4xl font-black text-slate-800 ltr py-2" dir="ltr">0.000 g</div>
                                <div id="recommendationTextSimple" class="text-sm font-bold mt-1 text-slate-500 mb-3">...</div>
                                
                                <!-- Added Details Section -->
                                <div class="border-t border-black/5 pt-3 mt-2 grid grid-cols-2 gap-4 text-xs">
                                    <div class="text-right">
                                        <span class="block text-slate-500 mb-1">ุงุฑุฒุด ุณูุฏ/ุฒุงู</span>
                                        <span id="profitTomansSimple" class="font-bold text-slate-700 text-sm">0</span>
                                    </div>
                                    <div class="text-left">
                                         <span class="block text-slate-500 mb-1">ุฏุฑุตุฏ ุฑุดุฏ</span>
                                         <span id="profitPercentSimple" class="font-bold text-slate-700 text-sm ltr">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2 h-64 relative">
                            <canvas id="arbitrageChartSimple"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: AUCTION STRATEGY (New Logic) -->
            <div id="tab-auction" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 relative">
                    
                    <!-- Step 1: Sell High Bubble -->
                    <div class="lg:col-span-1 bg-white rounded-xl border border-red-200 shadow-sm p-4 relative">
                        <div class="text-xs font-bold text-red-500 mb-2 uppercase tracking-wide">ฺฏุงู ฑ: ุชุงูู ููุฏูฺฏ</div>
                        <h3 class="font-bold text-slate-800 mb-4">ูุฑูุด ุฏุงุฑุง ูุนู</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-500">ุฏุงุฑุง ูพุฑุญุจุงุจ (ูุฑูุด)</label>
                                <select id="aucSellType" class="w-full p-2 border rounded text-sm bg-slate-50" onchange="calcAuction()">
                                    <option value="half">ูู ุณฺฉู</option>
                                    <option value="quarter">ุฑุจุน ุณฺฉู</option>
                                    <option value="full">ุชูุงู ุณฺฉู</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="text-xs text-slate-500">ุชุนุฏุงุฏ</label>
                                    <input type="number" id="aucSellQty" value="10" class="w-full p-2 border rounded text-center font-bold" oninput="calcAuction()">
                                </div>
                                <div class="flex-[2]">
                                    <label class="text-xs text-slate-500">ููุช ูุฑูุด (ุชููุงู)</label>
                                    <input type="text" id="aucSellPrice" value="82,000,000" class="w-full p-2 border rounded ltr text-sm" oninput="formatInput(this); calcAuction()">
                                </div>
                            </div>
                            <div class="pt-2 border-t mt-2">
                                <div class="flex justify-between text-xs font-bold text-red-700">
                                    <span>ููุฏูฺฏ ฺฉู:</span>
                                    <span id="aucTotalCashStep1">0</span>
                                </div>
                            </div>
                        </div>
                        <!-- Connector Visual -->
                        <div class="step-connector hidden lg:block"></div>
                    </div>

                    <!-- Step 2: Bid in Auction -->
                    <div class="lg:col-span-1 bg-white rounded-xl border border-indigo-200 shadow-sm p-4 relative">
                        <div class="text-xs font-bold text-indigo-500 mb-2 uppercase tracking-wide">ฺฏุงู ฒ: ุดุฑฺฉุช ุฏุฑ ุญุฑุงุฌ</div>
                        <h3 class="font-bold text-slate-800 mb-4">ุซุจุช ุณูุงุฑุด ุญุฑุงุฌ</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-500">ุฏุงุฑุง ูุฏู (ุฎุฑุฏ)</label>
                                <select id="aucBuyType" class="w-full p-2 border rounded text-sm bg-slate-50" onchange="calcAuction()">
                                    <option value="full">ุชูุงู ุณฺฉู</option>
                                    <option value="half">ูู ุณฺฉู</option>
                                    <option value="quarter">ุฑุจุน ุณฺฉู</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500">ููุช ูพุดููุงุฏ ุดูุง (ุชููุงู)</label>
                                <input type="text" id="aucBidPrice" value="135,000,000" class="w-full p-2 border rounded ltr text-sm font-bold text-indigo-700 bg-indigo-50" oninput="formatInput(this); calcAuction()">
                                <p class="text-[10px] text-indigo-400 mt-1">* ฺฉุงุฑูุฒุฏ ุญุฑุงุฌ (0.1%) ูุญุงุธ ูโุดูุฏ</p>
                            </div>
                            <div class="pt-2 border-t mt-2 bg-indigo-50/50 p-2 rounded">
                                <div class="flex justify-between text-xs text-indigo-800 mb-1">
                                    <span>ุชุนุฏุงุฏ ูุงุจู ุฎุฑุฏ:</span>
                                    <span id="aucBuyQty" class="font-bold text-lg">0</span>
                                </div>
                                <div class="flex justify-between text-[10px] text-indigo-500">
                                    <span>ูุงูุฏู ููุฏูฺฏ:</span>
                                    <span id="aucCashRemainsStep2">0</span>
                                </div>
                            </div>
                        </div>
                         <div class="step-connector hidden lg:block"></div>
                    </div>

                    <!-- Step 3: Sell After Delivery -->
                    <div class="lg:col-span-1 bg-white rounded-xl border border-orange-200 shadow-sm p-4 relative">
                        <div class="text-xs font-bold text-orange-500 mb-2 uppercase tracking-wide">ฺฏุงู ณ: ูุฑูุด (ฒ ููุชู ุจุนุฏ)</div>
                        <h3 class="font-bold text-slate-800 mb-4">ุชุณูู ููุง</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-500">ูพุดโุจู ููุช ุจุงุฒุงุฑ (ุชููุงู)</label>
                                <input type="text" id="aucFuturePrice" value="147,000,000" class="w-full p-2 border rounded ltr text-sm" oninput="formatInput(this); calcAuction()">
                                <p class="text-[10px] text-slate-400 mt-1">ููุช ุงุญุชูุงู ุณฺฉู ุฏุฑ ุฒูุงู ุชุญูู</p>
                            </div>
                            
                            <div class="pt-4 border-t mt-2">
                                <div class="flex justify-between text-xs font-bold text-orange-700">
                                    <span>ููุฏูฺฏ ููุง:</span>
                                    <span id="aucTotalCashStep3">0</span>
                                </div>
                            </div>
                        </div>
                         <div class="step-connector hidden lg:block"></div>
                    </div>

                    <!-- Step 4: Convert to Melted -->
                    <div class="lg:col-span-1 bg-emerald-50 rounded-xl border border-emerald-200 shadow-sm p-4 relative">
                        <div class="text-xs font-bold text-emerald-600 mb-2 uppercase tracking-wide">ฺฏุงู ด: ูุฏู ููุง</div>
                        <h3 class="font-bold text-emerald-900 mb-4">ุชุจุฏู ุจู ุขุจุดุฏู</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-emerald-700">ููุช ูุธูู/ฺฏุฑู ุขุจุดุฏู</label>
                                <input type="text" id="aucMeltedPrice" placeholder="ููุช ูุฑ ฺฏุฑู 18" class="w-full p-2 border border-emerald-300 rounded ltr text-sm" oninput="formatInput(this); calcAuction()">
                            </div>
                            
                            <div class="mt-4 bg-white p-3 rounded-lg border border-emerald-100 shadow-sm">
                                <div class="text-center">
                                    <div class="text-xs text-slate-500 mb-1">ุงูุฒุงุด ูุฒู ุทูุง</div>
                                    <div id="aucNetWeight" class="text-2xl font-black text-emerald-600 ltr" dir="ltr">+0.00 g</div>
                                    <div id="aucProfit" class="text-xs font-bold text-emerald-500 mt-1">0 ุชููุงู ุณูุฏ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Explanation Box -->
                <div class="mt-6 bg-blue-50 border border-blue-100 rounded-xl p-4 text-xs text-blue-800 leading-6">
                    <strong>๐ก ุชุญูู ููุดููุฏ ุณูุงุฑู:</strong>
                    <p id="aucAnalysisText">ูุทูุง ููุงุฏุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ ุชุง ุชุญูู ุณูุงุฑู ููุงุด ุฏุงุฏู ุดูุฏ. ุฏุฑ ุงู ุงุณุชุฑุงุชฺุ ูุฏู ุชุจุฏู ุฏุงุฑุง ุจุง ุญุจุงุจ ุจุงูุง ุจู ุฏุงุฑุง ุญุฑุงุฌ (ฺฉู ุญุจุงุจ) ู ุฏุฑ ููุงุช ุชุซุจุช ุณูุฏ ุฏุฑ ุทูุง ุขุจุดุฏู ุงุณุช.</p>
                </div>
            </div>

        </div>
    </div>

<script>
    // --- Shared Constants ---
    const COIN_WEIGHTS = {
        'full': 8.133,
        'half': 4.0665,
        'quarter': 2.03325
    };
    const RATIO_18K_TO_COIN = 750 / 900; 
    const AUCTION_FEE_PERCENT = 0.001; // 0.1% fee

    // --- Tab Switching ---
    function switchTab(tabId) {
        // Update Buttons
        document.getElementById('tabBtn-simple').className = `flex-1 py-4 text-sm font-bold border-b-2 transition-colors ${tabId === 'simple' ? 'text-slate-600 border-slate-600 bg-white' : 'text-slate-400 border-transparent hover:bg-slate-50'}`;
        document.getElementById('tabBtn-auction').className = `flex-1 py-4 text-sm font-bold border-b-2 transition-colors ${tabId === 'auction' ? 'text-indigo-600 border-indigo-600 bg-white' : 'text-indigo-300 border-transparent hover:bg-indigo-50'}`;
        
        // Update Content
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        
        // Recalculate based on active tab
        if(tabId === 'simple') calculateSimple();
        else calcAuction();
    }

    // --- Shared Utils ---
    const formatCurrency = (num) => new Intl.NumberFormat('fa-IR').format(Math.floor(num));
    const formatWeight = (num) => num.toFixed(3);
    
    function formatInput(el) {
        let val = el.value.replace(/,/g, '').replace(/\D/g, '');
        if (val) el.value = parseInt(val).toLocaleString('en-US');
        else el.value = '';
    }
    
    function getRawValue(id) {
        const el = document.getElementById(id);
        if(!el) return 0;
        const val = el.value.replace(/,/g, '').replace(/\D/g, '');
        return parseFloat(val) || 0;
    }

    // --- Simple Calculator Logic (Existing) ---
    let chartInstance = null;
    function calculateSimple() {
        let totalCash = 0;
        let totalSoldWeightCoinBasis = 0;

        function processRow(qtyId, priceId, weightPerUnit, isMelted = false) {
            const qtyEl = document.getElementById(qtyId);
            const q = parseFloat(qtyEl.value) || 0;
            const p = getRawValue(priceId);
            
            if (q > 0) {
                totalCash += (q * p);
                if (isMelted) totalSoldWeightCoinBasis += (q * RATIO_18K_TO_COIN);
                else totalSoldWeightCoinBasis += (q * weightPerUnit);
            }
        }

        processRow('qtyFull', 'priceFull', COIN_WEIGHTS.full);
        processRow('qtyHalf', 'priceHalf', COIN_WEIGHTS.half);
        processRow('qtyQuarter', 'priceQuarter', COIN_WEIGHTS.quarter);
        processRow('qtyMelted', 'priceMelted', 0, true);

        const buyType = document.getElementById('buyTypeSimple').value;
        const buyPrice = getRawValue('buyPriceSimple');
        
        document.getElementById('buyPriceLabelSimple').innerText = buyType === 'melted' ? "ููุช ูุฑ ฺฏุฑู ุทูุง ฑธ ุนุงุฑ" : "ููุช ุฎุฑุฏ ุณฺฉู (ุชููุงู)";

        let buyCountDisplay = "0";
        let cashRemains = 0;
        let totalBoughtWeightCoinBasis = 0;
        
        if (buyPrice > 0) {
            if (buyType === 'melted') {
                const gramsBought = totalCash / buyPrice;
                buyCountDisplay = gramsBought.toFixed(2) + " ฺฏุฑู";
                totalBoughtWeightCoinBasis = gramsBought * RATIO_18K_TO_COIN;
            } else {
                const coinWeight = COIN_WEIGHTS[buyType];
                const countFloor = Math.floor(totalCash / buyPrice);
                cashRemains = totalCash - (countFloor * buyPrice);
                buyCountDisplay = countFloor + " ุนุฏุฏ";
                const physicalWeight = countFloor * coinWeight;
                const cashEquivalentWeight = (cashRemains / buyPrice) * coinWeight;
                totalBoughtWeightCoinBasis = physicalWeight + cashEquivalentWeight;
            }
        }

        document.getElementById('totalCashSimple').innerText = formatCurrency(totalCash) + " ุชููุงู";
        document.getElementById('buyCountDisplaySimple').innerText = buyCountDisplay;
        document.getElementById('cashRemainsSimple').innerText = formatCurrency(cashRemains) + " ุชููุงู";

        const netDiff = totalBoughtWeightCoinBasis - totalSoldWeightCoinBasis;
        
        // --- Enhanced Result Calculation ---
        
        // 1. Calculate Profit in Tomans
        let pricePerGramCoinBasis = 0;
        if (buyPrice > 0) {
            if (buyType === 'melted') {
                pricePerGramCoinBasis = buyPrice / RATIO_18K_TO_COIN;
            } else {
                pricePerGramCoinBasis = buyPrice / COIN_WEIGHTS[buyType];
            }
        }
        const profitInTomans = netDiff * pricePerGramCoinBasis;
        
        // 2. Calculate Percentage Growth
        let percentGrowth = 0;
        if (totalSoldWeightCoinBasis > 0) {
            percentGrowth = (netDiff / totalSoldWeightCoinBasis) * 100;
        }

        // --- UI Updates ---
        const netElem = document.getElementById('netWeightValSimple');
        const recElem = document.getElementById('recommendationTextSimple');
        const cardElem = document.getElementById('resultCardSimple');
        const tomansElem = document.getElementById('profitTomansSimple');
        const percentElem = document.getElementById('profitPercentSimple');

        const sign = netDiff > 0 ? "+" : "";
        netElem.innerText = `${sign}${formatWeight(netDiff)} g`;
        
        // Update Monetary & Percent
        tomansElem.innerText = formatCurrency(Math.round(profitInTomans));
        percentElem.innerText = `${sign}${percentGrowth.toFixed(2)}%`;

        if (netDiff > 0.01) {
            cardElem.className = "p-4 rounded-xl border text-center bg-emerald-100 border-emerald-300 text-emerald-900";
            netElem.className = "text-4xl font-black text-emerald-700 ltr py-2";
            recElem.innerText = "โ ูุนุงููู ุณูุฏุฏู ุงุณุช";
            tomansElem.className = "font-bold text-emerald-700 text-sm";
            percentElem.className = "font-bold text-emerald-700 text-sm ltr";
        } else if (netDiff < -0.01) {
            cardElem.className = "p-4 rounded-xl border text-center bg-red-100 border-red-300 text-red-900";
            netElem.className = "text-4xl font-black text-red-700 ltr py-2";
            recElem.innerText = "โ ูุนุงููู ุฒุงูโุฏู ุงุณุช";
            tomansElem.className = "font-bold text-red-700 text-sm";
            percentElem.className = "font-bold text-red-700 text-sm ltr";
        } else {
            cardElem.className = "p-4 rounded-xl border text-center bg-yellow-50 border-yellow-200 text-yellow-900";
            netElem.className = "text-4xl font-black text-yellow-600 ltr py-2";
            recElem.innerText = "โ๏ธ ุณุฑ ุจู ุณุฑ";
            tomansElem.className = "font-bold text-yellow-700 text-sm";
            percentElem.className = "font-bold text-yellow-700 text-sm ltr";
        }

        updateChartSimple(totalSoldWeightCoinBasis, totalBoughtWeightCoinBasis);
        saveData();
    }

    function updateChartSimple(sold, bought) {
        const ctx = document.getElementById('arbitrageChartSimple').getContext('2d');
        const isProfit = bought >= sold;
        const boughtColor = isProfit ? '#10b981' : '#ef4444'; 

        if (chartInstance) {
            chartInstance.data.datasets[0].data = [sold, bought];
            chartInstance.data.datasets[0].backgroundColor = ['#94a3b8', boughtColor]; 
            chartInstance.update();
        } else {
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ูุฒู ูุจู', 'ูุฒู ุฌุฏุฏ'],
                    datasets: [{
                        label: 'ฺฏุฑู (ูุนุงุฏู ุณฺฉู)',
                        data: [sold, bought],
                        backgroundColor: ['#94a3b8', boughtColor],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#f1f5f9' }, ticks: { font: { family: 'Vazirmatn' } } },
                        x: { grid: { display: false }, ticks: { font: { family: 'Vazirmatn' } } }
                    }
                }
            });
        }
    }

    // --- AUCTION STRATEGY LOGIC (NEW) ---
    function calcAuction() {
        // Step 1: Initial Liquidity
        const sellType = document.getElementById('aucSellType').value;
        const sellQty = parseFloat(document.getElementById('aucSellQty').value) || 0;
        const sellPrice = getRawValue('aucSellPrice');
        
        const totalCashStep1 = sellQty * sellPrice;
        document.getElementById('aucTotalCashStep1').innerText = formatCurrency(totalCashStep1);

        // Step 2: Auction Bid
        const buyType = document.getElementById('aucBuyType').value;
        const bidPrice = getRawValue('aucBidPrice');
        
        let wonQty = 0;
        let cashRemainsStep2 = totalCashStep1;
        
        if (bidPrice > 0) {
            // Price + Fee calculation
            const costPerUnit = bidPrice * (1 + AUCTION_FEE_PERCENT); 
            wonQty = Math.floor(totalCashStep1 / costPerUnit);
            cashRemainsStep2 = totalCashStep1 - (wonQty * costPerUnit);
        }
        
        document.getElementById('aucBuyQty').innerText = wonQty + " ุนุฏุฏ";
        document.getElementById('aucCashRemainsStep2').innerText = formatCurrency(cashRemainsStep2);

        // Step 3: Future Sale
        const futurePrice = getRawValue('aucFuturePrice');
        const totalCashStep3 = (wonQty * futurePrice) + cashRemainsStep2; // Sell Auction coins + add leftover cash from step 2
        document.getElementById('aucTotalCashStep3').innerText = formatCurrency(totalCashStep3);

        // Step 4: Final Melted Conversion
        const meltedPrice = getRawValue('aucMeltedPrice');
        
        // Initial Weight (Coin Basis 900)
        const initialWeight = sellQty * COIN_WEIGHTS[sellType];
        
        // Final Weight (Melted converted to Coin Basis 900)
        let finalWeight = 0;
        if (meltedPrice > 0) {
            const meltedGrams = totalCashStep3 / meltedPrice;
            finalWeight = meltedGrams * RATIO_18K_TO_COIN;
        }

        // Net Result
        const netDiff = finalWeight - initialWeight;
        const profitTomans = totalCashStep3 - totalCashStep1; // Cash diff implies profit if converted back at same rates, but weight is better metric here.
        
        const netElem = document.getElementById('aucNetWeight');
        const sign = netDiff > 0 ? "+" : "";
        netElem.innerText = `${sign}${formatWeight(netDiff)} g`;
        netElem.className = `text-2xl font-black ltr ${netDiff >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
        
        document.getElementById('aucProfit').innerText = `${sign}${formatCurrency(profitTomans)} ุชููุงู ุงุฎุชูุงู ููุฏูฺฏ`;

        // Smart Analysis Text
        const analysisEl = document.getElementById('aucAnalysisText');
        if (netDiff > 0) {
            const percentGain = ((netDiff / initialWeight) * 100).toFixed(2);
            analysisEl.innerHTML = `โ <span class="text-emerald-700 font-bold">ุณูุงุฑู ูููู:</span> ุจุง ุงุฌุฑุง ุงู ุงุณุชุฑุงุชฺุ ุดูุง ูุฒู ุทูุง ุฎูุฏ ุฑุง ุญุฏูุฏ <strong>${percentGain}ูช</strong> ุงูุฒุงุด ูโุฏูุฏ.<br>ูฺฉุชู ฺฉูุฏ: ุดูุง ${sellQty} ${getTransactionName(sellType)} ูุฑูุฎุชุฏ ู ูุนุงุฏู ูุฒู ุขู ุฑุง ุจู ุขุจุดุฏู ุชุจุฏู ฺฉุฑุฏุฏุ ุฏุฑ ุญุงู ฺฉู ุงุฒ ุงุฎุชูุงู ููุช ุญุฑุงุฌ ุจูุฑู ุจุฑุฏุฏ.`;
        } else {
            analysisEl.innerHTML = `โ๏ธ <span class="text-red-600 font-bold">ุณูุงุฑู ุฒุงูโุฏู:</span> ููุช ูพุดููุงุฏ ุญุฑุงุฌ ุง ููุช ูุฑูุด ุขุช ุจุฑุง ูพูุดุด ุงุฎุชูุงู ูุฒู ฺฉุงู ูุณุช.<br>ูพุดููุงุฏ: ููุช ุจุฏ ุญุฑุงุฌ ุฑุง ฺฉุงูุด ุฏูุฏ ุง ููุชุธุฑ ููุช ุจุงูุงุชุฑ ุจุงุฒุงุฑ ุจูุงูุฏ.`;
        }
        saveData();
    }

    function getTransactionName(type) {
        if(type === 'full') return 'ุณฺฉู ุชูุงู';
        if(type === 'half') return 'ูู ุณฺฉู';
        if(type === 'quarter') return 'ุฑุจุน ุณฺฉู';
        return type;
    }

    // --- Storage ---
    function saveData() {
        const inputIds = [
            'qtyFull', 'priceFull', 'qtyHalf', 'priceHalf', 'qtyQuarter', 'priceQuarter', 
            'qtyMelted', 'priceMelted', 'buyTypeSimple', 'buyPriceSimple',
            // Auction Inputs
            'aucSellType', 'aucSellQty', 'aucSellPrice', 'aucBuyType', 'aucBidPrice', 'aucFuturePrice', 'aucMeltedPrice'
        ];
        
        const data = {};
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if(el) data[id] = el.value;
        });
        localStorage.setItem('goldArbitrageData_v2', JSON.stringify(data));
    }

    function loadData() {
        const savedData = localStorage.getItem('goldArbitrageData_v2');
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                for (const [key, value] of Object.entries(data)) {
                    const el = document.getElementById(key);
                    if (el) el.value = value;
                }
            } catch (e) { console.error(e); }
        }
    }

    window.addEventListener('load', () => {
        loadData();
        // Default Active Tab styling
        document.getElementById('tabBtn-simple').classList.add('text-slate-600', 'border-slate-600', 'bg-white');
        calculateSimple();
        calcAuction();
    });

</script>
</body>
</html>