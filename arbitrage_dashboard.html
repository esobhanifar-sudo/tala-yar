<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد تحلیل حباب و سیگنال آربیتراژ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- AUTHENTICATION (Supabase) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Optional: External Auth Script (Fail gracefully if missing) -->
    <script src="auth.js" onerror="console.warn('auth.js failed to load. Running in standalone mode.')"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Safe check for auth guard if it exists in auth.js
            if (typeof checkAuthGuard === 'function') {
                checkAuthGuard();
            } else {
                console.log("Standalone mode: skipping auth check.");
            }
            
            // Load Settings
            loadSettings();
        });
    </script>

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --num-scale: 1;
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --panel-border: rgba(255, 255, 255, 0.1);
            --item-hover: rgba(255,255,255,0.05);
            --border-color: #334155;
            --chart-grid: #1e293b;
            --chart-text: #64748b;
        }

        /* Light Mode Variables */
        body.light-mode {
            --bg-color: #f1f5f9;
            --text-color: #334155;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --panel-border: rgba(0, 0, 0, 0.05);
            --item-hover: rgba(0,0,0,0.03);
            --border-color: #e2e8f0;
            --chart-grid: #e2e8f0;
            --chart-text: #64748b;
        }

        /* Eye Care Filter */
        body.eye-care-mode {
            filter: sepia(0.25) contrast(0.95) brightness(0.95);
        }

        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: background-color 0.3s, color 0.3s, filter 0.3s;
        }

        .glass-panel { 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px); 
            border: 1px solid var(--panel-border); 
            transition: background 0.3s, border 0.3s;
        }
        
        /* Light Mode Shadow Adjustment */
        body.light-mode .glass-panel {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .chart-container { position: relative; height: 300px; width: 100%; }
        
        .ticker-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0.75rem; border-bottom: 1px solid var(--border-color); 
            transition: background 0.2s, border-color 0.3s; 
        }
        .ticker-item:hover { background: var(--item-hover); }
        
        .bubble-badge { font-size: calc(0.75rem * var(--num-scale)); padding: 2px 8px; border-radius: 99px; font-weight: bold; min-width: 50px; text-align: center; transition: font-size 0.2s; }
        .bubble-high { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #ef4444; } /* Sell Signal */
        body.light-mode .bubble-high { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; }
        
        .bubble-low { background-color: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid #10b981; } /* Buy Signal */
        body.light-mode .bubble-low { background-color: rgba(16, 185, 129, 0.1); color: #059669; }

        .bubble-mid { background-color: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid #f59e0b; }
        body.light-mode .bubble-mid { background-color: rgba(245, 158, 11, 0.1); color: #d97706; }

        /* Dynamic Font Size Classes for Numbers */
        .num-xxs { font-size: calc(0.625rem * var(--num-scale)); line-height: 1.2; transition: font-size 0.2s; } /* ~10px base */
        .num-xs  { font-size: calc(0.75rem * var(--num-scale)); line-height: 1.3; transition: font-size 0.2s; }  /* ~12px base */
        .num-sm  { font-size: calc(0.875rem * var(--num-scale)); line-height: 1.4; transition: font-size 0.2s; } /* ~14px base */
        .num-base{ font-size: calc(1rem * var(--num-scale)); line-height: 1.5; transition: font-size 0.2s; }     /* ~16px base */
        .num-lg  { font-size: calc(1.125rem * var(--num-scale)); line-height: 1.5; transition: font-size 0.2s; } /* ~18px base */
        .num-xl  { font-size: calc(1.5rem * var(--num-scale)); line-height: 1.5; transition: font-size 0.2s; }   /* ~24px base */
        
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fbbf24; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }
        body.light-mode input[type=range]::-webkit-slider-runnable-track {
            background: #cbd5e1;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #f59e0b;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #f59e0b;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 pb-20 selection:bg-amber-500 selection:text-white transition-colors duration-300">

    <!-- Header -->
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div class="text-center md:text-right">
            <h1 class="text-3xl font-bold text-amber-400 flex items-center justify-center md:justify-start gap-3">
                <div class="p-2 bg-amber-500/10 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                </div>
                رهدیس آنالیز
            </h1>
            <p class="text-sm opacity-60 mt-1 mr-14">رصد لحظه‌ای حباب و فرصت‌های آربیتراژ طلا</p>
        </div>
        <div class="flex gap-3">
            <a href="#" onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-5 py-2.5 rounded-xl text-sm transition font-medium">بازنشانی</a>
            <button onclick="fetchAllData()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl text-sm transition font-medium shadow-lg shadow-blue-900/20 flex items-center gap-2 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:rotate-180 transition duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                بروزرسانی داده‌ها
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
        
        <!-- Sidebar: Market Overview -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Recommendation Card -->
            <div class="glass-panel rounded-2xl p-6 border-r-4 border-amber-500 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-50"></div>
                <h3 class="text-sm font-bold opacity-80 mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span>
                    سیگنال هوشمند آربیتراژ
                </h3>
                <div id="recommendationBox" class="min-h-[100px] flex items-center justify-center">
                    <p class="text-xs opacity-60 animate-pulse">در حال تحلیل بازار...</p>
                </div>
            </div>

            <!-- Live Prices & Bubbles -->
            <div class="glass-panel rounded-2xl p-5 shadow-lg">
                <div class="flex justify-between items-end mb-4 border-b border-gray-500/20 pb-3">
                    <h3 class="text-xs font-bold opacity-60 uppercase">وضعیت حباب سکه‌ها</h3>
                    <span id="connectionStatus" class="text-[10px] px-2 py-0.5 rounded bg-slate-800 text-slate-400">در حال اتصال...</span>
                </div>
                
                <div id="marketList" class="space-y-2">
                    <!-- Items injected by JS -->
                </div>
                
                <!-- Error Log Area -->
                <div id="errorLog" class="mt-4 p-3 bg-red-900/20 border border-red-900/50 rounded-lg text-[10px] text-red-300 font-mono hidden break-all"></div>
            </div>

            <!-- Settings -->
            <div class="glass-panel rounded-2xl p-5">
                <h3 class="text-sm font-bold opacity-80 mb-3 border-b border-gray-500/20 pb-2">تنظیمات و راحتی چشم</h3>
                
                <!-- Visual Comfort: Theme & Eye Care -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                     <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" id="themeBtn" class="flex flex-col items-center justify-center p-2 rounded-lg bg-gray-500/10 hover:bg-gray-500/20 transition border border-gray-500/10">
                        <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1 text-amber-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <span class="text-[10px] opacity-70">تم رنگی</span>
                    </button>
                    <!-- Eye Care Toggle -->
                    <button onclick="toggleEyeCare()" id="eyeCareBtn" class="flex flex-col items-center justify-center p-2 rounded-lg bg-gray-500/10 hover:bg-gray-500/20 transition border border-gray-500/10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        <span class="text-[10px] opacity-70">محافظ چشم</span>
                    </button>
                </div>

                <!-- Font Size Slider -->
                <div class="mb-4">
                    <label class="text-xs opacity-60 block mb-2 font-medium flex justify-between">
                        <span>بزرگ‌نمایی اعداد</span>
                        <span id="scaleValueDisplay" class="text-amber-500 font-mono">1.0x</span>
                    </label>
                    <input type="range" id="fontScaleSlider" min="0.8" max="1.6" step="0.1" value="1" 
                           oninput="updateNumberScale(this.value)" class="w-full">
                    <div class="flex justify-between text-[10px] opacity-50 mt-1">
                        <span>کوچک</span>
                        <span>استاندارد</span>
                        <span>بزرگ</span>
                    </div>
                </div>

                <label class="text-xs opacity-60 block mb-3 font-medium">فیلتر بازه زمانی</label>
                <div class="flex bg-gray-500/10 rounded-lg p-1 border border-gray-500/10">
                    <button onclick="fetchHistory(7)" class="flex-1 text-xs py-1.5 rounded-md hover:bg-gray-500/20 text-gray-400 focus:bg-gray-500/30 focus:text-amber-500 shadow-sm transition">7 روز</button>
                    <button onclick="fetchHistory(30)" class="flex-1 text-xs py-1.5 rounded-md hover:bg-gray-500/20 text-gray-400 focus:bg-gray-500/30 focus:text-amber-500 transition">30 روز</button>
                    <button onclick="fetchHistory(90)" class="flex-1 text-xs py-1.5 rounded-md hover:bg-gray-500/20 text-gray-400 focus:bg-gray-500/30 focus:text-amber-500 transition">90 روز</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area: Charts -->
        <div class="lg:col-span-3 space-y-6">
            
            <!-- Chart 1: Bubble Percentage -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold opacity-90 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                        روند حباب سکه و طلای ۱۸ (Bubble %)
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span>تمام</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span>نیم</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>ربع</span>
                        <span class="flex items-center text-[10px] text-purple-400 gap-1 border-r border-gray-500/30 pr-2 mr-1"><span class="w-3 h-0.5 bg-purple-500"></span>طلای ۱۸</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="bubbleChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Full Coin Specific Analysis (NEW) -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl border border-amber-500/30">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-amber-500 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        آنالیز اختصاصی تمام سکه: قیمت بازار vs ارزش ذاتی
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span>قیمت بازار</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>ارزش ذاتی (طلا)</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded bg-red-500/50"></span>شدت حباب (%)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="fullAnalysisChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Half Coin Specific Analysis (NEW) -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl border border-blue-500/30">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-blue-500 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12a8 8 0 00-8-8v8l5.5 5.5" /></svg>
                        آنالیز اختصاصی نیم سکه: قیمت بازار vs ارزش ذاتی
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span>قیمت بازار</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>ارزش ذاتی (طلا)</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded bg-red-500/50"></span>شدت حباب (%)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="halfAnalysisChart"></canvas>
                </div>
            </div>

            <!-- Chart 4: Quarter Coin Specific Analysis -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl border border-emerald-500/30">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-emerald-500 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        آنالیز اختصاصی ربع سکه: قیمت بازار vs ارزش ذاتی
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>قیمت بازار</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>ارزش ذاتی (طلا)</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded bg-red-500/50"></span>شدت حباب (%)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="quarterChart"></canvas>
                </div>
            </div>

            <!-- Chart 5: Price Trends -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold opacity-90 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        روند کلی قیمت سکه‌ها (Price Toman)
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

        </div>

    </div>

<script>
    // --- Configuration ---
    // Fallback Supabase Config (Used if auth.js is missing/failing)
    const FB_URL = 'https://otlechriihxznnoamzbx.supabase.co';
    const FB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90bGVjaHJpaWh4em5ub2FtemJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0ODgyNjIsImV4cCI6MjA3ODA2NDI2Mn0._4eHezjQ_RI0Cjw_ZTz0Kxo-ysC4NN2Vexj8QUWBeLg';

    // Constants
    const COIN_SPECS = {
        'full': { name: 'تمام سکه', weight: 8.133, color: '#f59e0b', borderColor: '#fbbf24', dbKey: 'Avg_Emami' },
        'half': { name: 'نیم سکه', weight: 4.0665, color: '#3b82f6', borderColor: '#60a5fa', dbKey: 'Avg_Half' },
        'quarter': { name: 'ربع سکه', weight: 2.03325, color: '#10b981', borderColor: '#34d399', dbKey: 'Avg_Quarter' }
    };
    const PURITY_FACTOR = 0.900 / 0.750; // 1.2

    // --- State ---
    let bubbleChartInstance = null;
    let priceChartInstance = null;
    let fullAnalysisChartInstance = null;
    let halfAnalysisChartInstance = null;
    let quarterChartInstance = null;
    let supabaseClient = null;
    let globalFontScale = 1;
    let isLightMode = false;

    // --- Helpers ---
    
    function loadSettings() {
        // Load saved font scale
        const savedScale = localStorage.getItem('numScale');
        if (savedScale) {
            updateNumberScale(parseFloat(savedScale));
            document.getElementById('fontScaleSlider').value = savedScale;
        }

        // Load Theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            setTheme(true);
        }

        // Load Eye Care
        const savedEyeCare = localStorage.getItem('eyeCare');
        if (savedEyeCare === 'true') {
            toggleEyeCareUI(true);
        }
    }

    // --- Theme & Visual Comfort Logic ---
    function toggleTheme() {
        setTheme(!isLightMode);
    }

    function setTheme(light) {
        isLightMode = light;
        const body = document.body;
        const iconMoon = document.getElementById('themeIconMoon');
        const iconSun = document.getElementById('themeIconSun');

        if (light) {
            body.classList.add('light-mode');
            iconMoon.classList.add('hidden');
            iconSun.classList.remove('hidden');
            localStorage.setItem('theme', 'light');
        } else {
            body.classList.remove('light-mode');
            iconMoon.classList.remove('hidden');
            iconSun.classList.add('hidden');
            localStorage.setItem('theme', 'dark');
        }
        
        updateChartTheme();
    }

    function toggleEyeCare() {
        const body = document.body;
        const active = body.classList.toggle('eye-care-mode');
        toggleEyeCareUI(active);
        localStorage.setItem('eyeCare', active);
    }

    function toggleEyeCareUI(active) {
        const body = document.body;
        const btn = document.getElementById('eyeCareBtn');
        if (active) {
            body.classList.add('eye-care-mode');
            btn.classList.add('ring-2', 'ring-amber-500', 'bg-amber-500/10');
        } else {
            body.classList.remove('eye-care-mode');
            btn.classList.remove('ring-2', 'ring-amber-500', 'bg-amber-500/10');
        }
    }

    function updateChartTheme() {
        // Update Chart Defaults based on CSS Variables
        const style = getComputedStyle(document.body);
        const gridColor = style.getPropertyValue('--chart-grid').trim();
        const textColor = style.getPropertyValue('--chart-text').trim();

        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;

        const charts = [bubbleChartInstance, priceChartInstance, fullAnalysisChartInstance, halfAnalysisChartInstance, quarterChartInstance];
        charts.forEach(chart => {
            if (chart) {
                chart.options.scales.x.grid.color = gridColor;
                chart.options.scales.y.grid.color = gridColor;
                chart.update('none');
            }
        });
    }

    function updateNumberScale(val) {
        globalFontScale = parseFloat(val);
        document.documentElement.style.setProperty('--num-scale', val);
        document.getElementById('scaleValueDisplay').innerText = val + 'x';
        localStorage.setItem('numScale', val);
        
        const newSize = Math.round(12 * globalFontScale);
        Chart.defaults.font.size = newSize;
        
        const charts = [bubbleChartInstance, priceChartInstance, fullAnalysisChartInstance, halfAnalysisChartInstance, quarterChartInstance];
        charts.forEach(chart => {
            if (chart) {
                chart.options.scales.x.ticks.font = { size: Math.max(10, newSize - 2), family: 'Vazirmatn' };
                chart.options.scales.y.ticks.font = { size: Math.max(10, newSize - 2), family: 'Vazirmatn' };
                chart.update('none');
            }
        });
    }

    function parsePrice(value) {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
            const clean = value.replace(/,/g, '').replace(/[^\d.]/g, '');
            const parsed = parseFloat(clean);
            return isNaN(parsed) ? 0 : parsed;
        }
        return 0;
    }

    function getSupabaseClient() {
        if (supabaseClient) return supabaseClient;
        if (typeof sb !== 'undefined') {
            supabaseClient = sb;
            return sb;
        }
        if (typeof supabase !== 'undefined') {
            const { createClient } = supabase;
            supabaseClient = createClient(FB_URL, FB_KEY);
            return supabaseClient;
        }
        return null;
    }

    function calculateMetrics(marketPrice, weight, gram18kPrice) {
        if (!marketPrice || !gram18kPrice) return { intrinsicValue: 0, bubbleAmount: 0, bubblePercent: 0 };
        
        const intrinsicValue = weight * (gram18kPrice * PURITY_FACTOR);
        const bubbleAmount = marketPrice - intrinsicValue;
        const bubblePercent = (bubbleAmount / intrinsicValue) * 100;
        
        return { intrinsicValue, bubbleAmount, bubblePercent };
    }

    // --- Data Fetching ---

    async function fetchLiveTicker() {
        const statusEl = document.getElementById('connectionStatus');
        const errorLog = document.getElementById('errorLog');
        
        // UI Feedback
        statusEl.innerText = "درحال دریافت...";
        statusEl.className = "text-[10px] px-2 py-0.5 rounded bg-yellow-500/20 text-yellow-500 animate-pulse";
        
        const client = getSupabaseClient();
        if (!client) return;

        try {
            const { data, error } = await client
                .from('Iran_Data')
                .select('Gram_18K_Price, Emami_Coin_Price, Half_Coin_Price, Quarter_Coin_Price')
                .order('id', { ascending: false })
                .limit(1)
                .single();
            
            if (data && !error) {
                const gram18k = parsePrice(data.Gram_18K_Price) / 10;
                const prices = {
                    full: parsePrice(data.Emami_Coin_Price) / 10,
                    half: parsePrice(data.Half_Coin_Price) / 10,
                    quarter: parsePrice(data.Quarter_Coin_Price) / 10
                };
                
                statusEl.innerText = "آنلاین";
                statusEl.className = "text-[10px] px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400";
                
                // Process Ticker Analysis
                const analysis = [];
                for (const [key, spec] of Object.entries(COIN_SPECS)) {
                    const m = calculateMetrics(prices[key], spec.weight, gram18k);
                    analysis.push({ key: key, name: spec.name, price: prices[key], ...m });
                }

                renderSidebar(analysis, gram18k);
                analyzeArbitrage(analysis);
                
            } else {
                throw error || new Error("No data");
            }
        } catch (e) {
            console.error(e);
            statusEl.innerText = "خطا";
            statusEl.className = "text-[10px] px-2 py-0.5 rounded bg-red-500/20 text-red-400";
            errorLog.innerText = e.message;
            errorLog.classList.remove('hidden');
        }
    }

    async function fetchHistory(days = 30) {
        const client = getSupabaseClient();
        if (!client) return;
        
        // Clear current data
        if (bubbleChartInstance) { bubbleChartInstance.data.datasets.forEach(ds => ds.data = []); bubbleChartInstance.update(); }
        if (priceChartInstance) { priceChartInstance.data.datasets.forEach(ds => ds.data = []); priceChartInstance.update(); }
        if (fullAnalysisChartInstance) { fullAnalysisChartInstance.data.datasets.forEach(ds => ds.data = []); fullAnalysisChartInstance.update(); }
        if (halfAnalysisChartInstance) { halfAnalysisChartInstance.data.datasets.forEach(ds => ds.data = []); halfAnalysisChartInstance.update(); }
        if (quarterChartInstance) { quarterChartInstance.data.datasets.forEach(ds => ds.data = []); quarterChartInstance.update(); }

        try {
            // Fetch aggregated history
            // FIXED: Get newest data (descending), then reverse for display
            const { data, error } = await client
                .from('Iran_Data_Daily_Summary')
                .select('Date, Avg_Gram_18K, Avg_Emami, Avg_Half, Avg_Quarter')
                .order('Date', { ascending: false }) // Newest First
                .limit(days);

            if (data && !error) {
                // Reverse to make it Oldest -> Newest (Left to Right)
                data.reverse();

                const labels = [];
                // Bubble Datasets
                const fullBubble = [];
                const halfBubble = [];
                const quarterBubble = [];
                const goldPrice = [];
                
                // Price Datasets (Tomans)
                const fullPrice = [];
                const halfPrice = [];
                const quarterPrice = [];

                // Analysis Specific Arrays
                const fullIntrinsic = [];
                const fullBubblePct = [];
                const halfIntrinsic = [];
                const halfBubblePct = [];
                const quarterIntrinsic = [];
                const quarterBubblePct = [];

                data.forEach(day => {
                    // Convert Gregorian string to Persian Date for display
                    const dateObj = new Date(day.Date);
                    const label = dateObj.toLocaleDateString('fa-IR', { month: '2-digit', day: '2-digit' });
                    labels.push(label);

                    const gram18kRials = parseFloat(day.Avg_Gram_18K);
                    const gram18kToman = gram18kRials / 10;
                    
                    const pFullRials = parseFloat(day.Avg_Emami);
                    const pHalfRials = parseFloat(day.Avg_Half);
                    const pQuarterRials = parseFloat(day.Avg_Quarter);

                    // Calculate Metrics
                    const fullMetrics = calculateMetrics(pFullRials, COIN_SPECS.full.weight, gram18kRials);
                    const halfMetrics = calculateMetrics(pHalfRials, COIN_SPECS.half.weight, gram18kRials);
                    const quarterMetrics = calculateMetrics(pQuarterRials, COIN_SPECS.quarter.weight, gram18kRials);
                    
                    fullBubble.push(fullMetrics.bubblePercent);
                    halfBubble.push(halfMetrics.bubblePercent);
                    quarterBubble.push(quarterMetrics.bubblePercent);
                    goldPrice.push(gram18kToman);

                    // Raw Prices (Tomans)
                    fullPrice.push(pFullRials / 10);
                    halfPrice.push(pHalfRials / 10);
                    quarterPrice.push(pQuarterRials / 10);

                    // Populate Analysis Data
                    fullIntrinsic.push(fullMetrics.intrinsicValue / 10);
                    fullBubblePct.push(fullMetrics.bubblePercent);
                    
                    halfIntrinsic.push(halfMetrics.intrinsicValue / 10);
                    halfBubblePct.push(halfMetrics.bubblePercent);

                    quarterIntrinsic.push(quarterMetrics.intrinsicValue / 10);
                    quarterBubblePct.push(quarterMetrics.bubblePercent);
                });

                // Update Bubble Chart
                if (bubbleChartInstance) {
                    bubbleChartInstance.data.labels = labels;
                    bubbleChartInstance.data.datasets[0].data = fullBubble;
                    bubbleChartInstance.data.datasets[1].data = halfBubble;
                    bubbleChartInstance.data.datasets[2].data = quarterBubble;
                    bubbleChartInstance.data.datasets[3].data = goldPrice;
                    bubbleChartInstance.update();
                }

                // Update Price Chart
                if (priceChartInstance) {
                    priceChartInstance.data.labels = labels;
                    priceChartInstance.data.datasets[0].data = fullPrice;
                    priceChartInstance.data.datasets[1].data = halfPrice;
                    priceChartInstance.data.datasets[2].data = quarterPrice;
                    priceChartInstance.update();
                }

                // Update Full Coin Analysis
                if (fullAnalysisChartInstance) {
                    fullAnalysisChartInstance.data.labels = labels;
                    fullAnalysisChartInstance.data.datasets[0].data = fullIntrinsic;
                    fullAnalysisChartInstance.data.datasets[1].data = fullPrice;
                    fullAnalysisChartInstance.data.datasets[2].data = fullBubblePct;
                    fullAnalysisChartInstance.update();
                }

                // Update Half Coin Analysis
                if (halfAnalysisChartInstance) {
                    halfAnalysisChartInstance.data.labels = labels;
                    halfAnalysisChartInstance.data.datasets[0].data = halfIntrinsic;
                    halfAnalysisChartInstance.data.datasets[1].data = halfPrice;
                    halfAnalysisChartInstance.data.datasets[2].data = halfBubblePct;
                    halfAnalysisChartInstance.update();
                }

                // Update Quarter Analysis Chart
                if (quarterChartInstance) {
                    quarterChartInstance.data.labels = labels;
                    // Dataset 0: Intrinsic (Gold Value)
                    quarterChartInstance.data.datasets[0].data = quarterIntrinsic;
                    // Dataset 1: Market Price
                    quarterChartInstance.data.datasets[1].data = quarterPrice;
                    // Dataset 2: Bubble %
                    quarterChartInstance.data.datasets[2].data = quarterBubblePct;
                    quarterChartInstance.update();
                }
                
                // Ensure charts pick up the correct theme initially
                updateChartTheme();

            } else {
                console.warn("History fetch failed:", error);
            }
        } catch (e) {
            console.error("History Error:", e);
        }
    }

    function fetchAllData() {
        fetchLiveTicker();
        fetchHistory(30);
    }

    // --- UI Logic ---

    function analyzeArbitrage(analysis) {
        analysis.sort((a, b) => b.bubblePercent - a.bubblePercent);
        const highest = analysis[0];
        const lowest = analysis[analysis.length - 1];
        const gap = highest.bubblePercent - lowest.bubblePercent;
        const container = document.getElementById('recommendationBox');
        
        if (gap > 2) { 
            container.innerHTML = `
                <div class="w-full flex flex-col gap-3">
                    <div class="flex justify-between items-center p-2 rounded bg-red-500/10 border border-red-500/30">
                        <span class="text-xs text-red-400/80">فروش (حباب زیاد)</span>
                        <span class="text-sm font-black text-red-400">${highest.name}</span>
                    </div>
                    <div class="flex justify-center text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>
                    </div>
                    <div class="flex justify-between items-center p-2 rounded bg-emerald-500/10 border border-emerald-500/30">
                        <span class="text-xs text-emerald-400/80">خرید (حباب کم)</span>
                        <span class="text-sm font-black text-emerald-400">${lowest.name}</span>
                    </div>
                    <div class="mt-1 text-center">
                        <span class="text-[10px] opacity-60">سود احتمالی جابجایی:</span>
                        <span class="num-lg text-amber-500 font-bold ltr font-mono ml-1">${gap.toFixed(1)}%</span>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = `<div class="text-center opacity-60 text-xs leading-5">بازار در تعادل نسبی است.<br>اختلاف حباب‌ها ناچیز (${gap.toFixed(1)}%) است.</div>`;
        }
    }

    function renderSidebar(analysis, baseGold) {
        const list = document.getElementById('marketList');
        const displayOrder = ['full', 'half', 'quarter'];
        
        let html = `<div class="text-[10px] opacity-70 mb-3 text-center bg-gray-500/10 rounded py-1 border border-gray-500/10">
            قیمت طلای ۱۸ عیار: <span class="font-mono text-amber-500/90 num-xs">${baseGold.toLocaleString()}</span> تومان
        </div>`;

        displayOrder.forEach(key => {
            const item = analysis.find(a => a.key === key);
            if (!item) return;

            let badgeClass = 'bubble-mid';
            if (item.bubblePercent > 18) badgeClass = 'bubble-high';
            if (item.bubblePercent < 8) badgeClass = 'bubble-low';

            html += `
                <div class="ticker-item group">
                    <div>
                        <div class="text-sm font-bold opacity-90 group-hover:opacity-100 transition">${item.name}</div>
                        <div class="num-xxs opacity-60 font-mono mt-0.5">${item.price.toLocaleString()} T</div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <div class="${badgeClass} bubble-badge ltr font-mono">${item.bubblePercent.toFixed(1)}%</div>
                        <div class="num-xxs opacity-50 mt-1 ltr font-mono">Gap: ${(item.bubbleAmount/1000000).toFixed(2)} M</div>
                    </div>
                </div>
            `;
        });
        list.innerHTML = html;
    }

    // --- Charts Logic ---

    function initCharts() {
        Chart.defaults.font.family = 'Vazirmatn';
        Chart.defaults.color = '#64748b';
        // Base Font Size, will be updated by slider
        Chart.defaults.font.size = 12;

        // 1. Bubble Chart
        const ctxBubble = document.getElementById('bubbleChart').getContext('2d');
        bubbleChartInstance = new Chart(ctxBubble, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'تمام سکه', data: [], borderColor: COIN_SPECS.full.borderColor, backgroundColor: COIN_SPECS.full.color, borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#0f172a', yAxisID: 'y' },
                    { label: 'نیم سکه', data: [], borderColor: COIN_SPECS.half.borderColor, backgroundColor: COIN_SPECS.half.color, borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#0f172a', yAxisID: 'y' },
                    { label: 'ربع سکه', data: [], borderColor: COIN_SPECS.quarter.borderColor, backgroundColor: COIN_SPECS.quarter.color, borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#0f172a', yAxisID: 'y' },
                    { label: 'طلای ۱۸ عیار', data: [], borderColor: '#a855f7', backgroundColor: '#a855f7', borderWidth: 2, borderDash: [5, 5], tension: 0.3, pointRadius: 0, pointHoverRadius: 4, yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6 } },
                    tooltip: { rtl: true, callbacks: { label: (ctx) => { if (ctx.dataset.yAxisID === 'y1') return ` ${ctx.dataset.label}: ${parseInt(ctx.parsed.y).toLocaleString()} T`; return ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`; } } }
                },
                scales: {
                    y: { type: 'linear', display: true, position: 'left', grid: { color: '#1e293b' }, title: { display: true, text: 'درصد حباب (%)' } },
                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: false }, ticks: { display: false } }, // Hide Gold Price ticks to avoid clutter, just show line
                    x: { grid: { display: false } }
                }
            }
        });

        // Helper for Shared Options
        const sharedAnalysisOptions = {
            responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6 } },
                tooltip: { 
                    rtl: true, 
                    callbacks: { 
                        label: (ctx) => {
                            if (ctx.dataset.yAxisID === 'y1') return ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`;
                            return ` ${ctx.dataset.label}: ${parseInt(ctx.parsed.y).toLocaleString()} T`; 
                        } 
                    } 
                }
            },
            scales: {
                y: { 
                    type: 'linear', display: true, position: 'left', grid: { color: '#1e293b' }, 
                    ticks: { callback: (val) => (val/1000000).toFixed(1) + 'M' } 
                },
                y1: { 
                    type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false },
                    title: { display: true, text: 'درصد حباب', color: '#ef4444' },
                    ticks: { color: '#ef4444' },
                    suggestedMax: 100 // Keep bars somewhat low
                },
                x: { grid: { display: false } }
            }
        };

        // 2. Full Coin Analysis Chart (NEW)
        const ctxFull = document.getElementById('fullAnalysisChart').getContext('2d');
        fullAnalysisChartInstance = new Chart(ctxFull, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'ارزش ذاتی (طلا)', data: [], borderColor: '#fef08a', backgroundColor: 'rgba(254, 240, 138, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
                    { label: 'قیمت بازار', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', borderWidth: 2, fill: '-1', tension: 0.4, pointRadius: 3, yAxisID: 'y' },
                    { label: 'شدت حباب (%)', data: [], type: 'bar', backgroundColor: 'rgba(239, 68, 68, 0.3)', borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, yAxisID: 'y1' }
                ]
            },
            options: sharedAnalysisOptions
        });

        // 3. Half Coin Analysis Chart (NEW)
        const ctxHalf = document.getElementById('halfAnalysisChart').getContext('2d');
        halfAnalysisChartInstance = new Chart(ctxHalf, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'ارزش ذاتی (طلا)', data: [], borderColor: '#eab308', backgroundColor: 'rgba(234, 179, 8, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
                    { label: 'قیمت بازار', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, fill: '-1', tension: 0.4, pointRadius: 3, yAxisID: 'y' },
                    { label: 'شدت حباب (%)', data: [], type: 'bar', backgroundColor: 'rgba(239, 68, 68, 0.3)', borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, yAxisID: 'y1' }
                ]
            },
            options: sharedAnalysisOptions
        });

        // 4. Quarter Analysis Chart
        const ctxQuarter = document.getElementById('quarterChart').getContext('2d');
        quarterChartInstance = new Chart(ctxQuarter, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'ارزش ذاتی (طلا)', data: [], borderColor: '#eab308', backgroundColor: 'rgba(234, 179, 8, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
                    { label: 'قیمت بازار', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 2, fill: '-1', tension: 0.4, pointRadius: 3, yAxisID: 'y' },
                    { label: 'شدت حباب (%)', data: [], type: 'bar', backgroundColor: 'rgba(239, 68, 68, 0.3)', borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, yAxisID: 'y1' }
                ]
            },
            options: sharedAnalysisOptions
        });

        // 5. Price Chart
        const ctxPrice = document.getElementById('priceChart').getContext('2d');
        priceChartInstance = new Chart(ctxPrice, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'تمام سکه', data: [], borderColor: COIN_SPECS.full.borderColor, backgroundColor: COIN_SPECS.full.color, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: 'نیم سکه', data: [], borderColor: COIN_SPECS.half.borderColor, backgroundColor: COIN_SPECS.half.color, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: 'ربع سکه', data: [], borderColor: COIN_SPECS.quarter.borderColor, backgroundColor: COIN_SPECS.quarter.color, borderWidth: 2, tension: 0.3, pointRadius: 3 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6 } },
                    tooltip: { rtl: true, callbacks: { label: (ctx) => ` ${ctx.dataset.label}: ${parseInt(ctx.parsed.y).toLocaleString()} T` } }
                },
                scales: {
                    y: { grid: { color: '#1e293b' }, ticks: { callback: (val) => (val/1000000).toFixed(0) + 'M' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- Init ---
    initCharts();
    fetchAllData();
    setInterval(fetchLiveTicker, 60000); 

</script>
</body>
</html>