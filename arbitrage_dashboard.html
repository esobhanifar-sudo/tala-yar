<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد تحلیل حباب و سیگنال آربیتراژ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- AUTHENTICATION (Supabase) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Optional: External Auth Script (Fail gracefully if missing) -->
    <script src="auth.js" onerror="console.warn('auth.js failed to load. Running in standalone mode.')"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Safe check for auth guard if it exists in auth.js
            if (typeof checkAuthGuard === 'function') {
                checkAuthGuard();
            } else {
                console.log("Standalone mode: skipping auth check.");
            }
            
            // Load Settings
            loadSettings();
        });
    </script>

    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            --num-scale: 1;
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --panel-border: rgba(255, 255, 255, 0.1);
            --item-hover: rgba(255,255,255,0.05);
            --border-color: #334155;
            --chart-grid: #1e293b;
            --chart-text: #64748b;
            /* High Contrast Variable for Tablets */
            --num-weight: 500;
            --num-brightness: 1;
        }

        /* Light Mode Variables */
        body.light-mode {
            --bg-color: #f1f5f9;
            --text-color: #334155;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --panel-border: rgba(0, 0, 0, 0.05);
            --item-hover: rgba(0,0,0,0.03);
            --border-color: #e2e8f0;
            --chart-grid: #e2e8f0;
            --chart-text: #64748b;
        }

        /* Eye Care Filter */
        body.eye-care-mode {
            filter: sepia(0.25) contrast(0.95) brightness(0.95);
        }

        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            transition: background-color 0.3s, color 0.3s, filter 0.3s;
        }

        .glass-panel { 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px); 
            border: 1px solid var(--panel-border); 
            transition: background 0.3s, border 0.3s;
        }
        
        /* Light Mode Shadow Adjustment */
        body.light-mode .glass-panel {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .chart-container { position: relative; height: 300px; width: 100%; }
        
        .ticker-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0.75rem; border-bottom: 1px solid var(--border-color); 
            transition: background 0.2s, border-color 0.3s; 
        }
        .ticker-item:hover { background: var(--item-hover); }
        
        .bubble-badge { font-size: calc(0.75rem * var(--num-scale)); padding: 2px 8px; border-radius: 99px; font-weight: bold; min-width: 50px; text-align: center; transition: font-size 0.2s; }
        .bubble-high { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #ef4444; } /* Sell Signal */
        body.light-mode .bubble-high { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; }
        
        .bubble-low { background-color: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid #10b981; } /* Buy Signal */
        body.light-mode .bubble-low { background-color: rgba(16, 185, 129, 0.1); color: #059669; }

        .bubble-mid { background-color: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid #f59e0b; }
        body.light-mode .bubble-mid { background-color: rgba(245, 158, 11, 0.1); color: #d97706; }

        /* --- Number Styling (Latin Digits & Contrast) --- */
        /* Force English/Latin digits using standard system monospace fonts */
        .latin-nums {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
            direction: ltr;
            unicode-bidi: embed;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
        }

        /* Dynamic Font Size Classes for Numbers */
        .num-xxs { font-size: calc(0.625rem * var(--num-scale)); line-height: 1.2; transition: font-size 0.2s; } 
        .num-xs  { font-size: calc(0.75rem * var(--num-scale)); line-height: 1.3; transition: font-size 0.2s; }  
        .num-sm  { font-size: calc(0.875rem * var(--num-scale)); line-height: 1.4; transition: font-size 0.2s; } 
        .num-base{ font-size: calc(1rem * var(--num-scale)); line-height: 1.5; transition: font-size 0.2s; }     
        .num-lg  { font-size: calc(1.125rem * var(--num-scale)); line-height: 1.5; transition: font-size 0.2s; } 
        .num-xl  { font-size: calc(1.5rem * var(--num-scale)); line-height: 1.5; transition: font-size 0.2s; }   
        
        /* Apply Latin Nums to all num-* classes */
        .num-xxs, .num-xs, .num-sm, .num-base, .num-lg, .num-xl {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
            direction: ltr;
            unicode-bidi: embed;
            font-weight: var(--num-weight);
        }

        /* --- Tablet High Contrast Improvements --- */
        /* On medium screens (tablets) and up, make numbers bolder and brighter */
        @media (min-width: 768px) {
            :root {
                --num-weight: 800; /* Extra Bold on tablets */
            }
            .num-xxs, .num-xs, .num-sm, .num-base, .num-lg, .num-xl {
                text-shadow: 0 1px 1px rgba(0,0,0,0.3); /* Slight shadow for pop */
            }
            body:not(.light-mode) .num-xxs, 
            body:not(.light-mode) .num-xs, 
            body:not(.light-mode) .num-sm, 
            body:not(.light-mode) .num-base, 
            body:not(.light-mode) .num-lg, 
            body:not(.light-mode) .num-xl {
                color: #ffffff !important; /* Pure white in dark mode for max contrast */
            }
            body.light-mode .num-xxs, 
            body.light-mode .num-xs, 
            body.light-mode .num-sm, 
            body.light-mode .num-base, 
            body.light-mode .num-lg, 
            body.light-mode .num-xl {
                color: #0f172a !important; /* Very dark slate in light mode */
            }
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fbbf24; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }
        body.light-mode input[type=range]::-webkit-slider-runnable-track {
            background: #cbd5e1;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #f59e0b;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #f59e0b;
        }

        /* Table Styles */
        .comparison-table th {
            font-weight: 700; /* Bold headers */
            font-size: 0.85rem; /* Larger font */
            opacity: 0.8;
            padding: 1rem 0.75rem; /* More padding */
            text-align: center;
            white-space: nowrap; /* Prevent wrap */
        }
        .comparison-table td {
            padding: 0.75rem; /* More padding */
            text-align: center;
            border-top: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .comparison-table tr:hover td {
            background-color: var(--item-hover);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 pb-20 selection:bg-amber-500 selection:text-white transition-colors duration-300">

    <!-- Header -->
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="text-center md:text-right">
            <h1 class="text-3xl font-bold text-amber-400 flex items-center justify-center md:justify-start gap-3">
                <div class="p-2 bg-amber-500/10 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                </div>
                رهدیس آنالیز
            </h1>
            <p class="text-sm opacity-60 mt-1 mr-14">رصد لحظه‌ای حباب و فرصت‌های آربیتراژ طلا</p>
        </div>
        <div class="flex gap-3">
            <a href="/" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-5 py-2.5 rounded-xl text-sm transition font-medium flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                بازگشت به خانه
            </a>
            <button onclick="fetchAllData()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl text-sm transition font-medium shadow-lg shadow-blue-900/20 flex items-center gap-2 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:rotate-180 transition duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                بروزرسانی داده‌ها
            </button>
        </div>
    </div>

    <!-- MAIN SECTION: Live Prices & Bubbles Comparison (Full Width) -->
    <div class="max-w-7xl mx-auto mb-6">
        <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl border border-amber-500/20">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 border-b border-gray-500/20 pb-3 gap-2">
                <h3 class="text-xl font-bold text-amber-400 flex items-center gap-2">
                     <span class="w-3 h-3 rounded-full bg-amber-500 animate-pulse"></span>
                     تابلوی جامع مقایسه زنده قیمت و حباب (تومان)
                </h3>
                <span id="connectionStatus" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400 border border-slate-700">در حال اتصال...</span>
            </div>
            
            <div id="marketList" class="overflow-x-auto">
                 <!-- Table injected by JS -->
                 <div class="text-center text-sm opacity-50 py-8">در انتظار داده‌ها...</div>
            </div>
            
            <!-- Error Log Area -->
            <div id="errorLog" class="mt-4 p-3 bg-red-900/20 border border-red-900/50 rounded-lg text-xs text-red-300 font-mono hidden break-all"></div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
        
        <!-- Sidebar: Settings & Controls -->
        <div class="lg:col-span-1 space-y-4">
            
            <!-- Settings -->
            <div class="glass-panel rounded-2xl p-5 sticky top-4">
                <h3 class="text-sm font-bold opacity-80 mb-3 border-b border-gray-500/20 pb-2">تنظیمات و راحتی چشم</h3>
                
                <!-- Visual Comfort: Theme & Eye Care -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                     <!-- Theme Toggle -->
                    <button onclick="toggleTheme()" id="themeBtn" class="flex flex-col items-center justify-center p-2 rounded-lg bg-gray-500/10 hover:bg-gray-500/20 transition border border-gray-500/10">
                        <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1 text-amber-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <span class="text-[10px] opacity-70">تم رنگی</span>
                    </button>
                    <!-- Eye Care Toggle -->
                    <button onclick="toggleEyeCare()" id="eyeCareBtn" class="flex flex-col items-center justify-center p-2 rounded-lg bg-gray-500/10 hover:bg-gray-500/20 transition border border-gray-500/10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        <span class="text-[10px] opacity-70">محافظ چشم</span>
                    </button>
                </div>

                <!-- Font Size Slider -->
                <div class="mb-4">
                    <label class="text-xs opacity-60 block mb-2 font-medium flex justify-between">
                        <span>بزرگ‌نمایی اعداد</span>
                        <span id="scaleValueDisplay" class="text-amber-500 font-mono">1.0x</span>
                    </label>
                    <input type="range" id="fontScaleSlider" min="0.8" max="1.6" step="0.1" value="1" 
                           oninput="updateNumberScale(this.value)" class="w-full">
                    <div class="flex justify-between text-[10px] opacity-50 mt-1">
                        <span>کوچک</span>
                        <span>استاندارد</span>
                        <span>بزرگ</span>
                    </div>
                </div>

                <label class="text-xs opacity-60 block mb-3 font-medium">فیلتر بازه زمانی</label>
                <div class="flex bg-gray-500/10 rounded-lg p-1 border border-gray-500/10">
                    <button onclick="fetchHistory(7)" class="flex-1 text-xs py-1.5 rounded-md hover:bg-gray-500/20 text-gray-400 focus:bg-gray-500/30 focus:text-amber-500 shadow-sm transition">7 روز</button>
                    <button onclick="fetchHistory(30)" class="flex-1 text-xs py-1.5 rounded-md hover:bg-gray-500/20 text-gray-400 focus:bg-gray-500/30 focus:text-amber-500 transition">30 روز</button>
                    <button onclick="fetchHistory(90)" class="flex-1 text-xs py-1.5 rounded-md hover:bg-gray-500/20 text-gray-400 focus:bg-gray-500/30 focus:text-amber-500 transition">90 روز</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area: Charts -->
        <div class="lg:col-span-3 space-y-6">
            
            <!-- Chart 1: Bubble Percentage -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold opacity-90 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>
                        روند حباب سکه و طلای ۱۸ (Bubble %)
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span>تمام</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span>نیم</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>ربع</span>
                        <span class="flex items-center text-[10px] text-purple-400 gap-1 border-r border-gray-500/30 pr-2 mr-1"><span class="w-3 h-0.5 bg-purple-500"></span>طلای ۱۸</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="bubbleChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Full Coin Specific Analysis (NEW) -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl border border-amber-500/30">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-amber-500 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        آنالیز اختصاصی تمام سکه: قیمت بازار vs ارزش ذاتی
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span>قیمت بازار</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>ارزش ذاتی (طلا)</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded bg-red-500/50"></span>شدت حباب (%)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="fullAnalysisChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Half Coin Specific Analysis (NEW) -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl border border-blue-500/30">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-blue-500 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12a8 8 0 00-8-8v8l5.5 5.5" /></svg>
                        آنالیز اختصاصی نیم سکه: قیمت بازار vs ارزش ذاتی
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span>قیمت بازار</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>ارزش ذاتی (طلا)</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded bg-red-500/50"></span>شدت حباب (%)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="halfAnalysisChart"></canvas>
                </div>
            </div>

            <!-- Chart 4: Quarter Coin Specific Analysis -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl border border-emerald-500/30">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-emerald-500 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                        آنالیز اختصاصی ربع سکه: قیمت بازار vs ارزش ذاتی
                    </h2>
                    <div class="flex flex-wrap gap-3">
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>قیمت بازار</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>ارزش ذاتی (طلا)</span>
                        <span class="flex items-center text-[10px] opacity-60 gap-1"><span class="w-2 h-2 rounded bg-red-500/50"></span>شدت حباب (%)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="quarterChart"></canvas>
                </div>
            </div>

            <!-- Chart 5: Price Trends -->
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold opacity-90 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        روند کلی قیمت سکه‌ها (Price Toman)
                    </h2>
                </div>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

        </div>

    </div>

<script>
    // --- Configuration ---
    // Fallback Supabase Config (Used if auth.js is missing/failing)
    const FB_URL = 'https://otlechriihxznnoamzbx.supabase.co';
    const FB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90bGVjaHJpaWh4em5ub2FtemJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0ODgyNjIsImV4cCI6MjA3ODA2NDI2Mn0._4eHezjQ_RI0Cjw_ZTz0Kxo-ysC4NN2Vexj8QUWBeLg';

    // Constants
    const COIN_SPECS = {
        'full': { name: 'تمام سکه', weight: 8.133, color: '#f59e0b', borderColor: '#fbbf24', dbKey: 'Avg_Emami' },
        'half': { name: 'نیم سکه', weight: 4.0665, color: '#3b82f6', borderColor: '#60a5fa', dbKey: 'Avg_Half' },
        'quarter': { name: 'ربع سکه', weight: 2.03325, color: '#10b981', borderColor: '#34d399', dbKey: 'Avg_Quarter' }
    };
    const PURITY_FACTOR = 0.900 / 0.750; // 1.2

    // --- State ---
    let bubbleChartInstance = null;
    let priceChartInstance = null;
    let fullAnalysisChartInstance = null;
    let halfAnalysisChartInstance = null;
    let quarterChartInstance = null;
    let supabaseClient = null;
    let globalFontScale = 1;
    let isLightMode = false;
    // New global to store live data for charts
    let latestLiveData = { gold: 0, full: 0, half: 0, quarter: 0, valid: false };

    // --- Helpers ---
    
    function loadSettings() {
        // Load saved font scale
        const savedScale = localStorage.getItem('numScale');
        if (savedScale) {
            updateNumberScale(parseFloat(savedScale));
            const slider = document.getElementById('fontScaleSlider');
            if (slider) slider.value = savedScale;
        }

        // Load Theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            setTheme(true);
        }

        // Load Eye Care
        const savedEyeCare = localStorage.getItem('eyeCare');
        if (savedEyeCare === 'true') {
            toggleEyeCareUI(true);
        }
    }

    // --- Theme & Visual Comfort Logic ---
    function toggleTheme() {
        setTheme(!isLightMode);
    }

    function setTheme(light) {
        isLightMode = light;
        const body = document.body;
        const iconMoon = document.getElementById('themeIconMoon');
        const iconSun = document.getElementById('themeIconSun');

        if (light) {
            body.classList.add('light-mode');
            iconMoon.classList.add('hidden');
            iconSun.classList.remove('hidden');
            localStorage.setItem('theme', 'light');
        } else {
            body.classList.remove('light-mode');
            iconMoon.classList.remove('hidden');
            iconSun.classList.add('hidden');
            localStorage.setItem('theme', 'dark');
        }
        
        updateChartTheme();
    }

    function toggleEyeCare() {
        const body = document.body;
        const active = body.classList.toggle('eye-care-mode');
        toggleEyeCareUI(active);
        localStorage.setItem('eyeCare', active);
    }

    function toggleEyeCareUI(active) {
        const body = document.body;
        const btn = document.getElementById('eyeCareBtn');
        if (active) {
            body.classList.add('eye-care-mode');
            btn.classList.add('ring-2', 'ring-amber-500', 'bg-amber-500/10');
        } else {
            body.classList.remove('eye-care-mode');
            btn.classList.remove('ring-2', 'ring-amber-500', 'bg-amber-500/10');
        }
    }

    function updateChartTheme() {
        // Update Chart Defaults based on CSS Variables
        const style = getComputedStyle(document.body);
        const gridColor = style.getPropertyValue('--chart-grid').trim();
        const textColor = style.getPropertyValue('--chart-text').trim();

        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;

        const charts = [bubbleChartInstance, priceChartInstance, fullAnalysisChartInstance, halfAnalysisChartInstance, quarterChartInstance];
        charts.forEach(chart => {
            if (chart) {
                chart.options.scales.x.grid.color = gridColor;
                chart.options.scales.y.grid.color = gridColor;
                chart.update('none');
            }
        });
    }

    function updateNumberScale(val) {
        globalFontScale = parseFloat(val);
        document.documentElement.style.setProperty('--num-scale', val);
        const disp = document.getElementById('scaleValueDisplay');
        if (disp) disp.innerText = val + 'x';
        localStorage.setItem('numScale', val);
        
        const newSize = Math.round(12 * globalFontScale);
        Chart.defaults.font.size = newSize;
        
        const charts = [bubbleChartInstance, priceChartInstance, fullAnalysisChartInstance, halfAnalysisChartInstance, quarterChartInstance];
        charts.forEach(chart => {
            if (chart) {
                chart.options.scales.x.ticks.font = { size: Math.max(10, newSize - 2), family: 'Vazirmatn' };
                chart.options.scales.y.ticks.font = { size: Math.max(10, newSize - 2), family: 'Vazirmatn' };
                chart.update('none');
            }
        });
    }

    function parsePrice(value) {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
            const clean = value.replace(/,/g, '').replace(/[^\d.]/g, '');
            const parsed = parseFloat(clean);
            return isNaN(parsed) ? 0 : parsed;
        }
        return 0;
    }

    function getSupabaseClient() {
        if (supabaseClient) return supabaseClient;
        if (typeof sb !== 'undefined') {
            supabaseClient = sb;
            return sb;
        }
        if (typeof supabase !== 'undefined') {
            const { createClient } = supabase;
            supabaseClient = createClient(FB_URL, FB_KEY);
            return supabaseClient;
        }
        return null;
    }

    function calculateMetrics(marketPrice, weight, gram18kPrice) {
        if (!marketPrice || !gram18kPrice) return { intrinsicValue: 0, bubbleAmount: 0, bubblePercent: 0 };
        
        const intrinsicValue = weight * (gram18kPrice * PURITY_FACTOR);
        const bubbleAmount = marketPrice - intrinsicValue;
        const bubblePercent = (bubbleAmount / intrinsicValue) * 100;
        
        return { intrinsicValue, bubbleAmount, bubblePercent };
    }

    // --- Data Fetching & Comparision Logic ---

    async function fetchLiveTicker() {
        const statusEl = document.getElementById('connectionStatus');
        const errorLog = document.getElementById('errorLog');
        const listContainer = document.getElementById('marketList');
        
        // UI Feedback
        statusEl.innerText = "درحال دریافت...";
        statusEl.className = "text-[10px] px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-500 animate-pulse border border-yellow-500/30";
        
        const client = getSupabaseClient();
        if (!client) return;

        try {
            // Fetch data from all 3 sources simultaneously
            const [iranDataRes, currencyRes, milliRes] = await Promise.all([
                client.from('Iran_Data').select('*').order('id', { ascending: false }).limit(1).single(),
                client.from('irancurrency_price').select('*').order('id', { ascending: false }).limit(1).single(),
                client.from('Milli_Price').select('*').order('id', { ascending: false }).limit(1).single()
            ]);

            // Check for critical failures (if all fail, throw error)
            if (iranDataRes.error && currencyRes.error && milliRes.error) {
                throw new Error("All data sources failed.");
            }

            // Process Data Sources
            
            // 1. Iran Data (tgju)
            let iranSource = { name: "tgju", gold: 0, full: 0, half: 0, quarter: 0, dollar: 0, ounce: 0, valid: false, time: '-' };
            if (!iranDataRes.error && iranDataRes.data) {
                const d = iranDataRes.data;
                // Reverted to / 10 (Rials to Tomans) as requested
                iranSource.gold = parsePrice(d.Gram_18K_Price) / 10; 
                iranSource.full = parsePrice(d.Emami_Coin_Price) / 10;
                iranSource.half = parsePrice(d.Half_Coin_Price) / 10;
                iranSource.quarter = parsePrice(d.Quarter_Coin_Price) / 10;
                
                // TGJU Dollar: Adjusted to remove extra zeros (Rials / 10 to Tomans)
                iranSource.dollar = parsePrice(d.USD_AZAD_Exchange) / 10;
                
                // Ounce might not be in the user's specific table schema for Iran_Data, set to 0 if missing
                iranSource.ounce = 0; 

                // FIXED: Use "Timestamp" column as primary source per user schema
                let timeVal = d.Timestamp; 
                if (timeVal) {
                    const date = new Date(timeVal);
                    if (!isNaN(date.getTime())) {
                        iranSource.time = date.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                    } else {
                        iranSource.time = timeVal;
                    }
                } else {
                    iranSource.time = d.created_at 
                        ? new Date(d.created_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) 
                        : '-';
                }
                    
                iranSource.valid = true;
            }

            // 2. Iran Currency
            let currencySource = { name: "ایران کارنسی", gold: 0, full: 0, half: 0, quarter: 0, dollar: 0, ounce: 0, valid: false, time: '-' };
            if (!currencyRes.error && currencyRes.data) {
                const d = currencyRes.data;
                // Kept * 1000 as per specific request for this source
                currencySource.gold = (d.gold_18k || 0) * 1000;
                currencySource.full = (d.emami_coin || 0) * 1000;
                currencySource.half = (d.half_coin || 0) * 1000;
                currencySource.quarter = (d.quarter_coin || 0) * 1000;
                // Dollar: Removed multiplier to fix 000 issue
                currencySource.dollar = (d.dollar || 0);
                // Ounce usually comes as raw value (e.g. 2650), no scaling needed usually
                currencySource.ounce = (d.ouns || 0);

                // FIXED: Prioritize created_at to ensure HH:MM:SS format
                currencySource.time = d.created_at 
                    ? new Date(d.created_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) 
                    : (d.time || '-');
                    
                currencySource.valid = true;
            }

            // 3. Milli Price
            let milliSource = { name: "میلی", gold: 0, full: null, half: null, quarter: null, dollar: null, ounce: null, valid: false, time: '-' };
            if (!milliRes.error && milliRes.data) {
                const d = milliRes.data;
                const rawPrice = d.current_price || 0;
                
                // Reverted to heuristic logic to handle different units safely
                let estimatedGramPrice = rawPrice;
                if (estimatedGramPrice < 100000) estimatedGramPrice *= 1000; // If milli-unit
                if (estimatedGramPrice > 100000000) estimatedGramPrice /= 10; // If Rials

                milliSource.gold = estimatedGramPrice;
                
                // FIXED: Prioritize created_at to ensure HH:MM:SS format
                milliSource.time = d.created_at 
                    ? new Date(d.created_at).toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit', second:'2-digit'}) 
                    : (d.time || '-');
                    
                milliSource.valid = true;
            }

            // Capture Best Source for Charts
            // Priority: Iran Data > Currency > Milli (if coins exist)
            let bestSource = null;
            if (iranSource.valid && iranSource.gold > 0 && iranSource.full > 0) {
                bestSource = iranSource;
            } else if (currencySource.valid && currencySource.gold > 0 && currencySource.full > 0) {
                bestSource = currencySource;
            }

            if (bestSource) {
                latestLiveData = {
                    gold: bestSource.gold,
                    full: bestSource.full,
                    half: bestSource.half,
                    quarter: bestSource.quarter,
                    valid: true
                };
            }

            statusEl.innerText = "آنلاین";
            statusEl.className = "text-xs px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30";
            errorLog.classList.add('hidden');

            // --- Render Table ---
            const sources = [iranSource, currencySource, milliSource];
            const assets = [
                { id: 'ounce', label: 'انس جهانی', isGlobal: true },
                { id: 'dollar', label: 'دلار آزاد', isCurrency: true },
                { id: 'gold', label: 'طلای ۱۸ عیار', isGold: true },
                { id: 'full', label: 'تمام سکه', weight: COIN_SPECS.full.weight },
                { id: 'half', label: 'نیم سکه', weight: COIN_SPECS.half.weight },
                { id: 'quarter', label: 'ربع سکه', weight: COIN_SPECS.quarter.weight }
            ];

            // Added min-w for better scrolling on mobile
            let tableHTML = `
                <table class="w-full min-w-[600px] text-right comparison-table border-collapse">
                    <thead>
                        <tr class="text-sm text-white bg-amber-500 border-b border-amber-600 font-bold opacity-100">
                            <th class="p-3 w-1/4 rounded-tr-lg rounded-br-lg md:rounded-br-none md:rounded-bl-none md:rounded-tr-lg md:rounded-tl-none">شاخص</th>
                            ${sources.map((s, i) => `<th class="p-3 w-1/4 ${i === sources.length - 1 ? 'rounded-tl-lg rounded-bl-lg md:rounded-bl-none md:rounded-tr-none md:rounded-tl-lg' : ''}">${s.name}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Row for Update Time
            tableHTML += `<tr class="bg-gray-500/5">`;
            tableHTML += `<td class="text-xs font-bold text-amber-500 p-3">ساعت به‌روزرسانی</td>`;
            sources.forEach(source => {
                tableHTML += `<td class="text-xs font-mono font-bold ltr p-3 latin-nums">${source.time}</td>`;
            });
            tableHTML += `</tr>`;

            assets.forEach(asset => {
                tableHTML += `<tr>`;
                tableHTML += `<td class="text-sm font-bold opacity-90 p-3">${asset.label}</td>`;
                
                sources.forEach(source => {
                    if (!source.valid) {
                        tableHTML += `<td class="text-sm text-red-400/50 p-3">-</td>`;
                        return;
                    }

                    const price = source[asset.id];
                    
                    if (!price || price === 0) {
                        tableHTML += `<td class="text-sm opacity-30 p-3">-</td>`;
                    } else {
                        let displayValue = price.toLocaleString();
                        let suffix = '';
                        
                        if (asset.isGlobal) {
                            displayValue = '$' + price.toLocaleString(); // Add $ for Ounce
                        }

                        // Added 'latin-nums' explicitly to the container
                        let cellContent = `<div class="num-sm font-mono font-bold latin-nums">${displayValue}</div>`;
                        
                        // Calculate Bubble ONLY for coins (not dollar/ounce/gold itself)
                        // And only if we have gold price for this source
                        if (!asset.isGold && !asset.isCurrency && !asset.isGlobal && source.gold > 0) {
                            const m = calculateMetrics(price, asset.weight, source.gold);
                            
                            let badgeClass = 'text-amber-500';
                            if (m.bubblePercent > 18) badgeClass = 'text-red-400';
                            if (m.bubblePercent < 8) badgeClass = 'text-emerald-400';
                            
                            cellContent += `
                                <div class="${badgeClass} text-xs font-bold ltr font-mono mt-1 opacity-80 latin-nums">
                                    ${m.bubblePercent.toFixed(1)}%
                                </div>
                            `;
                        }
                        
                        tableHTML += `<td>${cellContent}</td>`;
                    }
                });
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;

        } catch (e) {
            console.error(e);
            statusEl.innerText = "خطا";
            statusEl.className = "text-xs px-3 py-1 rounded-full bg-red-500/20 text-red-400 border border-red-500/30";
            errorLog.innerText = e.message;
            errorLog.classList.remove('hidden');
        }
    }

    async function fetchHistory(days = 30) {
        const client = getSupabaseClient();
        if (!client) return;
        
        // Clear current data
        if (bubbleChartInstance) { bubbleChartInstance.data.datasets.forEach(ds => ds.data = []); bubbleChartInstance.update(); }
        if (priceChartInstance) { priceChartInstance.data.datasets.forEach(ds => ds.data = []); priceChartInstance.update(); }
        if (fullAnalysisChartInstance) { fullAnalysisChartInstance.data.datasets.forEach(ds => ds.data = []); fullAnalysisChartInstance.update(); }
        if (halfAnalysisChartInstance) { halfAnalysisChartInstance.data.datasets.forEach(ds => ds.data = []); halfAnalysisChartInstance.update(); }
        if (quarterChartInstance) { quarterChartInstance.data.datasets.forEach(ds => ds.data = []); quarterChartInstance.update(); }

        try {
            // 1. Fetch Aggregated Summary (Historical)
            const { data: summaryData, error } = await client
                .from('Iran_Data_Daily_Summary')
                .select('Date, Avg_Gram_18K, Avg_Emami, Avg_Half, Avg_Quarter')
                .order('Date', { ascending: false }) // Newest First
                .limit(days);

            // 2. Fetch Raw Data (to fill gaps in the last few days if Summary job failed)
            const { data: rawData, error: rawError } = await client
                .from('Iran_Data')
                .select('Gram_18K_Price, Emami_Coin_Price, Half_Coin_Price, Quarter_Coin_Price, Timestamp, created_at')
                .order('id', { ascending: false })
                .limit(1500); // Fetch enough back to cover ~5-7 days

            if ((summaryData && !error) || (rawData && !rawError)) {
                const combinedDataMap = new Map();

                // Helper to get Persian Date String
                const getPDate = (dateStr) => {
                    if (!dateStr) return null;
                    const d = new Date(dateStr);
                    if (isNaN(d.getTime())) return null;
                    return d.toLocaleDateString('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                };

                // A. Process Summary Data
                if (summaryData) {
                    summaryData.forEach(item => {
                        const pDate = getPDate(item.Date);
                        if (pDate) {
                            combinedDataMap.set(pDate, {
                                sortDate: new Date(item.Date).getTime(),
                                pDateLabel: pDate,
                                gram: parseFloat(item.Avg_Gram_18K),
                                full: parseFloat(item.Avg_Emami),
                                half: parseFloat(item.Avg_Half),
                                quarter: parseFloat(item.Avg_Quarter)
                            });
                        }
                    });
                }

                // B. Process Raw Data (Gap Fill)
                if (rawData) {
                    const dailyGroups = {};
                    rawData.forEach(row => {
                        const ts = row.Timestamp || row.created_at;
                        const pDate = getPDate(ts);
                        if (!pDate) return;

                        // Only process if NOT in Summary (Summary is authoritative/cleaner)
                        // AND not Today (Live point handles Today)
                        const todayP = new Date().toLocaleDateString('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                        
                        if (!combinedDataMap.has(pDate) && pDate !== todayP) {
                            if (!dailyGroups[pDate]) {
                                dailyGroups[pDate] = { count: 0, gram: 0, full: 0, half: 0, quarter: 0, ts: new Date(ts).getTime() };
                            }
                            dailyGroups[pDate].count++;
                            dailyGroups[pDate].gram += parsePrice(row.Gram_18K_Price);
                            dailyGroups[pDate].full += parsePrice(row.Emami_Coin_Price);
                            dailyGroups[pDate].half += parsePrice(row.Half_Coin_Price);
                            dailyGroups[pDate].quarter += parsePrice(row.Quarter_Coin_Price);
                        }
                    });

                    // Add aggregated raw days to map
                    Object.keys(dailyGroups).forEach(pDate => {
                        const g = dailyGroups[pDate];
                        if (g.count > 0) {
                            combinedDataMap.set(pDate, {
                                sortDate: g.ts, // Approximate timestamp for sorting
                                pDateLabel: pDate,
                                gram: g.gram / g.count,
                                full: g.full / g.count,
                                half: g.half / g.count,
                                quarter: g.quarter / g.count
                            });
                        }
                    });
                }

                // C. Convert Map to Array and Sort
                const finalHistory = Array.from(combinedDataMap.values())
                    .sort((a, b) => a.sortDate - b.sortDate);

                // D. Prepare Chart Arrays
                const labels = [];
                const fullBubble = [], halfBubble = [], quarterBubble = [], goldPrice = [];
                const fullPrice = [], halfPrice = [], quarterPrice = [];
                const fullIntrinsic = [], fullBubblePct = [];
                const halfIntrinsic = [], halfBubblePct = [];
                const quarterIntrinsic = [], quarterBubblePct = [];

                finalHistory.forEach(day => {
                    labels.push(day.pDateLabel);
                    
                    const gram18kRials = day.gram;
                    const gram18kToman = gram18kRials / 10;
                    
                    const pFullRials = day.full;
                    const pHalfRials = day.half;
                    const pQuarterRials = day.quarter;

                    // Calculate Metrics
                    const fullMetrics = calculateMetrics(pFullRials, COIN_SPECS.full.weight, gram18kRials);
                    const halfMetrics = calculateMetrics(pHalfRials, COIN_SPECS.half.weight, gram18kRials);
                    const quarterMetrics = calculateMetrics(pQuarterRials, COIN_SPECS.quarter.weight, gram18kRials);
                    
                    // Push to arrays
                    fullBubble.push(fullMetrics.bubblePercent);
                    halfBubble.push(halfMetrics.bubblePercent);
                    quarterBubble.push(quarterMetrics.bubblePercent);
                    goldPrice.push(gram18kToman);

                    // Raw Prices (Tomans)
                    fullPrice.push(pFullRials / 10);
                    halfPrice.push(pHalfRials / 10);
                    quarterPrice.push(pQuarterRials / 10);

                    // Populate Analysis Data
                    fullIntrinsic.push(fullMetrics.intrinsicValue / 10);
                    fullBubblePct.push(fullMetrics.bubblePercent);
                    
                    halfIntrinsic.push(halfMetrics.intrinsicValue / 10);
                    halfBubblePct.push(halfMetrics.bubblePercent);

                    quarterIntrinsic.push(quarterMetrics.intrinsicValue / 10);
                    quarterBubblePct.push(quarterMetrics.bubblePercent);
                });

                // --- APPEND LIVE DATA POINT ---
                if (latestLiveData && latestLiveData.valid && latestLiveData.full > 0) {
                    labels.push('لحظه‌ای'); // Label: Live/Current

                    const lFullM = calculateMetrics(latestLiveData.full, COIN_SPECS.full.weight, latestLiveData.gold);
                    const lHalfM = calculateMetrics(latestLiveData.half, COIN_SPECS.half.weight, latestLiveData.gold);
                    const lQuarterM = calculateMetrics(latestLiveData.quarter, COIN_SPECS.quarter.weight, latestLiveData.gold);

                    // Push Metrics
                    fullBubble.push(lFullM.bubblePercent);
                    halfBubble.push(lHalfM.bubblePercent);
                    quarterBubble.push(lQuarterM.bubblePercent);
                    goldPrice.push(latestLiveData.gold);

                    // Push Prices
                    fullPrice.push(latestLiveData.full);
                    halfPrice.push(latestLiveData.half);
                    quarterPrice.push(latestLiveData.quarter);

                    // Push Analysis
                    fullIntrinsic.push(lFullM.intrinsicValue);
                    fullBubblePct.push(lFullM.bubblePercent);

                    halfIntrinsic.push(lHalfM.intrinsicValue);
                    halfBubblePct.push(lHalfM.bubblePercent);

                    quarterIntrinsic.push(lQuarterM.intrinsicValue);
                    quarterBubblePct.push(lQuarterM.bubblePercent);
                }
                // ------------------------------

                // Update Bubble Chart
                if (bubbleChartInstance) {
                    bubbleChartInstance.data.labels = labels;
                    bubbleChartInstance.data.datasets[0].data = fullBubble;
                    bubbleChartInstance.data.datasets[1].data = halfBubble;
                    bubbleChartInstance.data.datasets[2].data = quarterBubble;
                    bubbleChartInstance.data.datasets[3].data = goldPrice;
                    bubbleChartInstance.update();
                }

                // Update Price Chart
                if (priceChartInstance) {
                    priceChartInstance.data.labels = labels;
                    priceChartInstance.data.datasets[0].data = fullPrice;
                    priceChartInstance.data.datasets[1].data = halfPrice;
                    priceChartInstance.data.datasets[2].data = quarterPrice;
                    priceChartInstance.update();
                }

                // Update Full Coin Analysis
                if (fullAnalysisChartInstance) {
                    fullAnalysisChartInstance.data.labels = labels;
                    fullAnalysisChartInstance.data.datasets[0].data = fullIntrinsic;
                    fullAnalysisChartInstance.data.datasets[1].data = fullPrice;
                    fullAnalysisChartInstance.data.datasets[2].data = fullBubblePct;
                    fullAnalysisChartInstance.update();
                }

                // Update Half Coin Analysis
                if (halfAnalysisChartInstance) {
                    halfAnalysisChartInstance.data.labels = labels;
                    halfAnalysisChartInstance.data.datasets[0].data = halfIntrinsic;
                    halfAnalysisChartInstance.data.datasets[1].data = halfPrice;
                    halfAnalysisChartInstance.data.datasets[2].data = halfBubblePct;
                    halfAnalysisChartInstance.update();
                }

                // Update Quarter Analysis Chart
                if (quarterChartInstance) {
                    quarterChartInstance.data.labels = labels;
                    // Dataset 0: Intrinsic (Gold Value)
                    quarterChartInstance.data.datasets[0].data = quarterIntrinsic;
                    // Dataset 1: Market Price
                    quarterChartInstance.data.datasets[1].data = quarterPrice;
                    // Dataset 2: Bubble %
                    quarterChartInstance.data.datasets[2].data = quarterBubblePct;
                    quarterChartInstance.update();
                }
                
                // Ensure charts pick up the correct theme initially
                updateChartTheme();

            } else {
                console.warn("History fetch failed:", error || rawError);
            }
        } catch (e) {
            console.error("History Error:", e);
        }
    }

    async function fetchAllData() {
        await fetchLiveTicker(); // Wait for live data to populate latestLiveData
        fetchHistory(30);
    }

    // --- Charts Logic ---

    function initCharts() {
        Chart.defaults.font.family = 'Vazirmatn';
        Chart.defaults.color = '#64748b';
        // Base Font Size, will be updated by slider
        Chart.defaults.font.size = 12;

        // 1. Bubble Chart
        const ctxBubble = document.getElementById('bubbleChart').getContext('2d');
        bubbleChartInstance = new Chart(ctxBubble, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'تمام سکه', data: [], borderColor: COIN_SPECS.full.borderColor, backgroundColor: COIN_SPECS.full.color, borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#0f172a', yAxisID: 'y' },
                    { label: 'نیم سکه', data: [], borderColor: COIN_SPECS.half.borderColor, backgroundColor: COIN_SPECS.half.color, borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#0f172a', yAxisID: 'y' },
                    { label: 'ربع سکه', data: [], borderColor: COIN_SPECS.quarter.borderColor, backgroundColor: COIN_SPECS.quarter.color, borderWidth: 2, tension: 0.3, pointRadius: 3, pointBackgroundColor: '#0f172a', yAxisID: 'y' },
                    { label: 'طلای ۱۸ عیار', data: [], borderColor: '#a855f7', backgroundColor: '#a855f7', borderWidth: 2, borderDash: [5, 5], tension: 0.3, pointRadius: 0, pointHoverRadius: 4, yAxisID: 'y1' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6 } },
                    tooltip: { rtl: true, callbacks: { label: (ctx) => { if (ctx.dataset.yAxisID === 'y1') return ` ${ctx.dataset.label}: ${parseInt(ctx.parsed.y).toLocaleString()} T`; return ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`; } } }
                },
                scales: {
                    y: { type: 'linear', display: true, position: 'left', grid: { color: '#1e293b' }, title: { display: true, text: 'درصد حباب (%)' } },
                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: false }, ticks: { display: false } }, // Hide Gold Price ticks to avoid clutter, just show line
                    x: { grid: { display: false } }
                }
            }
        });

        // Helper for Shared Options
        const sharedAnalysisOptions = {
            responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6 } },
                tooltip: { 
                    rtl: true, 
                    callbacks: { 
                        label: (ctx) => {
                            if (ctx.dataset.yAxisID === 'y1') return ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`;
                            return ` ${ctx.dataset.label}: ${parseInt(ctx.parsed.y).toLocaleString()} T`; 
                        } 
                    } 
                }
            },
            scales: {
                y: { 
                    type: 'linear', display: true, position: 'left', grid: { color: '#1e293b' }, 
                    ticks: { callback: (val) => (val/1000000).toFixed(1) + 'M' } 
                },
                y1: { 
                    type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false },
                    title: { display: true, text: 'درصد حباب', color: '#ef4444' },
                    ticks: { color: '#ef4444' },
                    suggestedMax: 100 // Keep bars somewhat low
                },
                x: { grid: { display: false } }
            }
        };

        // 2. Full Coin Analysis Chart (NEW)
        const ctxFull = document.getElementById('fullAnalysisChart').getContext('2d');
        fullAnalysisChartInstance = new Chart(ctxFull, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'ارزش ذاتی (طلا)', data: [], borderColor: '#fef08a', backgroundColor: 'rgba(254, 240, 138, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
                    { label: 'قیمت بازار', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', borderWidth: 2, fill: '-1', tension: 0.4, pointRadius: 3, yAxisID: 'y' },
                    { label: 'شدت حباب (%)', data: [], type: 'bar', backgroundColor: 'rgba(239, 68, 68, 0.3)', borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, yAxisID: 'y1' }
                ]
            },
            options: sharedAnalysisOptions
        });

        // 3. Half Coin Analysis Chart (NEW)
        const ctxHalf = document.getElementById('halfAnalysisChart').getContext('2d');
        halfAnalysisChartInstance = new Chart(ctxHalf, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'ارزش ذاتی (طلا)', data: [], borderColor: '#eab308', backgroundColor: 'rgba(234, 179, 8, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
                    { label: 'قیمت بازار', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, fill: '-1', tension: 0.4, pointRadius: 3, yAxisID: 'y' },
                    { label: 'شدت حباب (%)', data: [], type: 'bar', backgroundColor: 'rgba(239, 68, 68, 0.3)', borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, yAxisID: 'y1' }
                ]
            },
            options: sharedAnalysisOptions
        });

        // 4. Quarter Analysis Chart
        const ctxQuarter = document.getElementById('quarterChart').getContext('2d');
        quarterChartInstance = new Chart(ctxQuarter, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'ارزش ذاتی (طلا)', data: [], borderColor: '#eab308', backgroundColor: 'rgba(234, 179, 8, 0.1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
                    { label: 'قیمت بازار', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 2, fill: '-1', tension: 0.4, pointRadius: 3, yAxisID: 'y' },
                    { label: 'شدت حباب (%)', data: [], type: 'bar', backgroundColor: 'rgba(239, 68, 68, 0.3)', borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 1, yAxisID: 'y1' }
                ]
            },
            options: sharedAnalysisOptions
        });

        // 5. Price Chart
        const ctxPrice = document.getElementById('priceChart').getContext('2d');
        priceChartInstance = new Chart(ctxPrice, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'تمام سکه', data: [], borderColor: COIN_SPECS.full.borderColor, backgroundColor: COIN_SPECS.full.color, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: 'نیم سکه', data: [], borderColor: COIN_SPECS.half.borderColor, backgroundColor: COIN_SPECS.half.color, borderWidth: 2, tension: 0.3, pointRadius: 3 },
                    { label: 'ربع سکه', data: [], borderColor: COIN_SPECS.quarter.borderColor, backgroundColor: COIN_SPECS.quarter.color, borderWidth: 2, tension: 0.3, pointRadius: 3 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6 } },
                    tooltip: { rtl: true, callbacks: { label: (ctx) => ` ${ctx.dataset.label}: ${parseInt(ctx.parsed.y).toLocaleString()} T` } }
                },
                scales: {
                    y: { grid: { color: '#1e293b' }, ticks: { callback: (val) => (val/1000000).toFixed(0) + 'M' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- Init ---
    initCharts();
    fetchAllData();
    setInterval(fetchLiveTicker, 60000); 

</script>
</body>
</html>